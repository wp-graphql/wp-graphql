name: Reusable JS E2E Tests

on:
  workflow_call:
    inputs:
      name:
        description: 'Display name for the job (e.g., wp-graphql)'
        required: true
        type: string
      plugin_path:
        description: 'Path to the plugin directory (e.g., plugins/wp-graphql)'
        required: true
        type: string
      plugin_name:
        description: 'Name of the plugin (e.g., wp-graphql)'
        required: true
        type: string
      acf_pro:
        description: "For wp-graphql-acf: install ACF Pro when 'true' (requires ACF_LICENSE_KEY). Default 'false' = ACF Free (ACF Extended is not installed with ACF Free)."
        required: false
        type: string
        default: 'false'
      acf_extended_pro:
        description: "For wp-graphql-acf with ACF Pro: install ACF Extended Pro when 'true' (requires ACF_EXTENDED_LICENSE_KEY). Only used when acf_pro is 'true'; ignored when ACF Free. Default 'false' = ACF Extended Free."
        required: false
        type: string
        default: 'false'

jobs:
  # Runs JavaScript e2e tests for a WordPress plugin using Playwright.
  #
  # Performs the following steps:
  # - Checks out the repository.
  # - Sets up Node.js and PHP.
  # - Installs Composer and NPM dependencies.
  # - Builds JavaScript assets.
  # - Installs Playwright dependencies.
  # - Starts the wp-env Docker testing environment.
  # - Runs Playwright e2e tests.
  # - Uploads test failure artifacts.
  test:
    name: '${{ inputs.name }}'
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          show-progress: ${{ runner.debug == '1' && 'true' || 'false' }}
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          cache: 'npm'
          node-version-file: '.nvmrc'

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          tools: composer:v2
          extensions: json, mbstring, intl

      - name: Install Composer dependencies
        uses: ramsey/composer-install@v3
        with:
          working-directory: ${{ inputs.plugin_path }}
          composer-options: '--no-progress'

      # For plugins that depend on wp-graphql, we also need to install wp-graphql's dependencies
      # BEFORE wp-env starts so the vendor directory is available when WordPress loads the plugin
      # (wp-env maps plugin dirs as volumes, so host vendor dirs are available in containers)
      - name: Install wp-graphql dependencies (if needed)
        if: inputs.plugin_name != 'wp-graphql'
        uses: ramsey/composer-install@v3
        with:
          working-directory: plugins/wp-graphql
          composer-options: '--no-progress'

      - name: Install NPM dependencies
        run: npm ci

      # Build wp-graphql JS assets if this plugin depends on it
      # This must happen before wp-env starts so the built files are available in the container
      - name: Build wp-graphql (if required as dependency)
        if: inputs.plugin_name != 'wp-graphql'
        run: |
          echo "ðŸ“¦ Building wp-graphql (required dependency for ${{ inputs.plugin_name }})..."
          npm run build -w @wpgraphql/wp-graphql
          echo "âœ… wp-graphql built successfully"

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright system dependencies
        run: npx playwright install-deps chromium
        # Always run so host has required libs (cache only stores browser binaries, not system deps)

      - name: Install Playwright browsers
        run: npx playwright install chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'

      - name: Build JavaScript assets
        run: npm run build -- --filter='./plugins/*'

      - name: Cache Docker images
        uses: ScribeMD/docker-cache@0.5.0
        with:
          key: docker-${{ runner.os }}-e2e

      - name: Start the Docker testing environment
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            npm run wp-env start -- ${{ secrets.ACTIONS_STEP_DEBUG && '--debug' || '' }}

      - name: Log versions
        run: |
          npm run wp-env -- run cli php -- -v
          npm run wp-env -- run cli wp core version

      - name: Verify test environment
        run: |
          echo "Checking mu-plugin installation..."
          npm run wp-env run tests-cli -- ls -la /var/www/html/wp-content/mu-plugins/
          echo "Checking site URL..."
          npm run wp-env run tests-cli -- wp option get siteurl
          echo "Testing GraphQL endpoint (from container)..."
          npm run wp-env run tests-cli -- curl -s -o /dev/null -w "HTTP %{http_code}" http://tests-wordpress/graphql?query=%7B__typename%7D
          echo "Waiting for dev site (localhost:8888)..."
          for i in {1..30}; do
            if curl -f -s http://localhost:8888/wp-admin/install.php > /dev/null 2>&1 || curl -f -s http://localhost:8888/wp-admin > /dev/null 2>&1; then
              echo "Dev site ready."
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          curl -f -s http://localhost:8888/wp-admin/install.php > /dev/null || curl -f -s http://localhost:8888/wp-admin > /dev/null || (echo "Dev site (8888) not accessible!" && exit 1)
          echo "Waiting for test site (localhost:8889) â€“ used by Playwright E2E..."
          for i in {1..30}; do
            if curl -f -s http://localhost:8889/wp-admin/install.php > /dev/null 2>&1 || curl -f -s http://localhost:8889/wp-admin > /dev/null 2>&1; then
              echo "Test site ready."
              break
            fi
            echo "Waiting for test site... ($i/30)"
            sleep 2
          done
          curl -f -s http://localhost:8889/wp-admin/install.php > /dev/null || curl -f -s http://localhost:8889/wp-admin > /dev/null || (echo "Test site (8889) not accessible â€“ E2E tests use this port!" && exit 1)

      - name: Install plugin-specific test dependencies
        working-directory: ${{ inputs.plugin_path }}
        env:
          INSTALL_ACF_PRO: ${{ inputs.acf_pro }}
          INSTALL_ACF_EXTENDED_PRO: ${{ inputs.acf_extended_pro }}
          ACF_LICENSE_KEY: ${{ secrets.ACF_LICENSE_KEY }}
          ACF_EXTENDED_LICENSE_KEY: ${{ secrets.ACF_EXTENDED_LICENSE_KEY }}
        run: npm run install-test-deps

      # When ACF Pro is requested, verify the license is active. Without it, Pro fields (clone, repeater, etc.) are restricted and clone-schema E2E will fail.
      - name: Verify ACF Pro license (when Pro)
        if: inputs.plugin_name == 'wp-graphql-acf' && inputs.acf_pro == 'true'
        run: |
          STATUS=$(npm run wp-env run tests-cli -- wp eval 'echo ( function_exists( "acf_pro_is_license_active" ) && acf_pro_is_license_active() ) ? "active" : "inactive";' 2>/dev/null || echo "unknown")
          echo "ACF Pro license status: $STATUS"
          if [ "$STATUS" != "active" ]; then
            echo "::error::ACF Pro license is not active. Pro fields (clone, repeater, flexible content) will be restricted and clone-schema E2E tests will fail."
            echo "Ensure ACF_LICENSE_KEY repository secret is set and that the install step can reach ACF servers to activate the license."
            exit 1
          fi

      - name: Run E2E tests
        env:
          CI: true
          WP_BASE_URL: http://localhost:8889
          INSTALL_ACF_PRO: ${{ inputs.acf_pro }}
          INSTALL_ACF_EXTENDED_PRO: ${{ inputs.acf_extended_pro }}
        run: |
          npm run -w @wpgraphql/${{ inputs.plugin_name }} test:e2e

      - name: Stop WordPress Environment
        if: always()
        run: npm run wp-env -- stop || echo "wp-env not running or already stopped"

      - name: Upload test failure artifacts
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.plugin_name }}-e2e-test-failures
          path: |
            ${{ inputs.plugin_path }}/artifacts/test-results/**
            ${{ inputs.plugin_path }}/artifacts/storage-states/**
          if-no-files-found: ignore

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.plugin_name }}-e2e-playwright-report
          path: |
            ${{ inputs.plugin_path }}/artifacts/test-results/**
          if-no-files-found: ignore
