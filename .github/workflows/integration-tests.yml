name: Integration Tests

on:
  push:
    branches:
      - main
      - release/*
  pull_request:
    branches:
      - main
      - release/*
    paths:
      - ".github/workflows/integration-tests-reusable.yml"
      - ".github/workflows/integration-tests.yml"
      - "plugins/**/*.php"
      - "plugins/**/composer.json"
      - "plugins/**/composer.lock"
      - "plugins/**/package.json"
      - "plugins/**/package-lock.json"
      - "plugins/**/tests/**"
      - "plugins/**/codeception.dist.yml"
      - "package.json"
      - "package-lock.json"
      - ".wp-env.json"
      - "bin/**"
      - "!plugins/**/docs/**"
  workflow_dispatch:

# Cancel previous workflow run groups that have not completed.
concurrency:
  # Group workflow runs by workflow name, along with the head branch ref of the pull request
  # or otherwise the branch or tag ref.
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================
  # CHANGE DETECTION
  # ===========================================
  # Detects which plugins have changes to determine which test suites to run.
  # Each plugin job depends on this and only runs if its files changed.
  # ===========================================

  detect-changes:
    name: Detect changes
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      wp-graphql: ${{ steps.filter.outputs.wp-graphql_any_changed }}
      wp-graphql-smart-cache: ${{ steps.filter.outputs.wp-graphql-smart-cache_any_changed }}
      # Add outputs for additional plugins here:
      # wpgraphql-acf: ${{ steps.filter.outputs.wpgraphql-acf_any_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changed files
        id: filter
        uses: tj-actions/changed-files@v46
        with:
          files_yaml: |
            wp-graphql:
              - .github/workflows/integration-tests-reusable.yml
              - .github/workflows/integration-tests.yml
              - plugins/wp-graphql/**/*.php
              - plugins/wp-graphql/composer.json
              - plugins/wp-graphql/composer.lock
              - plugins/wp-graphql/package.json
              - plugins/wp-graphql/package-lock.json
              - plugins/wp-graphql/tests/**
              - plugins/wp-graphql/codeception.dist.yml
              - package.json
              - package-lock.json
              - .wp-env.json
              - bin/**
            wp-graphql-smart-cache:
              - .github/workflows/integration-tests-reusable.yml
              - .github/workflows/integration-tests.yml
              - plugins/wp-graphql-smart-cache/**/*.php
              - plugins/wp-graphql-smart-cache/composer.json
              - plugins/wp-graphql-smart-cache/composer.lock
              - plugins/wp-graphql-smart-cache/package.json
              - plugins/wp-graphql-smart-cache/package-lock.json
              - plugins/wp-graphql-smart-cache/tests/**
              - plugins/wp-graphql-smart-cache/codeception.dist.yml
              - plugins/wp-graphql/**/*.php
              - package.json
              - package-lock.json
              - .wp-env.json
              - bin/**
            # Add additional plugins here:
            # wpgraphql-acf:
            #   - .github/workflows/integration-tests-reusable.yml
            #   - .github/workflows/integration-tests.yml
            #   - plugins/wpgraphql-acf/**

      - name: Log detected changes
        run: |
          echo "wp-graphql changed: ${{ steps.filter.outputs.wp-graphql_any_changed }}"
          echo "wp-graphql-smart-cache changed: ${{ steps.filter.outputs.wp-graphql-smart-cache_any_changed }}"

  # ===========================================
  # TEST MATRIX
  # ===========================================
  # We use a "boundary testing" approach rather than testing every PHP √ó WP combination.
  # The rationale: if tests pass at version boundaries (oldest + newest), they almost
  # certainly pass for versions in between.
  #
  # - 4 coverage jobs: Latest WP/PHP with all theme √ó multisite combos
  # - 3 boundary jobs: Current stable, mid-range, oldest supported
  # - 1 experimental: WordPress trunk (allowed to fail)
  #
  # Update this matrix when new WP/PHP versions are released:
  # - WordPress releases ~3x/year: https://wordpress.org/about/roadmap/
  # - PHP support: https://www.php.net/supported-versions.php
  # - WP PHP requirements: https://make.wordpress.org/core/handbook/references/php-compatibility-and-target-versions/
  #
  # Last updated: 2026-01-21
  # ===========================================

  # Job naming strategy:
  # - Parent job name: "Integration: plugin / WP X.X / PHP X.X"
  # - Child job name: "theme (modifiers)" (from reusable workflow)
  # - Full name in branch protection: "Integration: wp-graphql / WP 6.9 / PHP 8.4 / twentytwentyfive üìä"
  wp-graphql:
    name: "Integration: ${{ matrix.name }}"
    needs: detect-changes
    if: needs.detect-changes.outputs.wp-graphql == 'true' || github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Coverage jobs: Latest WP/PHP with all theme √ó multisite combinations
          - name: "wp-graphql / WP 6.9 / PHP 8.4"
            php: "8.4"
            wp: "6.9"
            theme: twentytwentyfive
            multisite: false
            coverage: true
          - name: "wp-graphql / WP 6.9 / PHP 8.4"
            php: "8.4"
            wp: "6.9"
            theme: twentytwentyfive
            multisite: true
            coverage: true
          - name: "wp-graphql / WP 6.9 / PHP 8.4"
            php: "8.4"
            wp: "6.9"
            theme: twentytwentyone
            multisite: false
            coverage: true
          - name: "wp-graphql / WP 6.9 / PHP 8.4"
            php: "8.4"
            wp: "6.9"
            theme: twentytwentyone
            multisite: true
            coverage: true
          # Boundary: Current stable
          - name: "wp-graphql / WP 6.8 / PHP 8.3"
            php: "8.3"
            wp: "6.8"
            theme: twentytwentyfive
            multisite: false
            coverage: false
          # Boundary: Mid-range
          - name: "wp-graphql / WP 6.5 / PHP 8.1"
            php: "8.1"
            wp: "6.5"
            theme: twentytwentyone
            multisite: false
            coverage: false
          # Boundary: Oldest supported
          - name: "wp-graphql / WP 6.1 / PHP 7.4"
            php: "7.4"
            wp: "6.1"
            theme: twentytwentyone
            multisite: false
            coverage: false
          # Experimental: WordPress trunk (allowed to fail)
          - name: "wp-graphql / WP trunk / PHP 8.4"
            php: "8.4"
            wp: trunk
            theme: twentytwentyfive
            multisite: false
            coverage: false
            experimental: true
    uses: ./.github/workflows/integration-tests-reusable.yml
    secrets: inherit
    with:
      name: ${{ matrix.name }}
      plugin_path: plugins/wp-graphql
      plugin_name: wp-graphql
      wp: ${{ matrix.wp }}
      php: ${{ matrix.php }}
      theme: ${{ matrix.theme }}
      multisite: ${{ matrix.multisite }}
      coverage: ${{ matrix.coverage }}
      experimental: ${{ matrix.experimental || false }}

  # ===========================================
  # WP GraphQL Smart Cache
  # ===========================================
  # Tests the WP GraphQL Smart Cache plugin.
  # Smart Cache depends on WPGraphQL, so wp-graphql changes trigger these tests.
  # Uses a smaller matrix since coverage is collected from the core plugin.
  # ===========================================

  wp-graphql-smart-cache:
    name: "Integration: ${{ matrix.name }}"
    needs: detect-changes
    if: needs.detect-changes.outputs.wp-graphql-smart-cache == 'true' || github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Coverage job: Latest WP/PHP
          - name: "wp-graphql-smart-cache / WP 6.9 / PHP 8.4"
            php: "8.4"
            wp: "6.9"
            theme: twentytwentyfive
            multisite: false
            coverage: true
          # Boundary: Current stable
          - name: "wp-graphql-smart-cache / WP 6.8 / PHP 8.3"
            php: "8.3"
            wp: "6.8"
            theme: twentytwentyfive
            multisite: false
            coverage: false
          # Boundary: Oldest supported (matches wp-graphql PHP 7.4 requirement)
          - name: "wp-graphql-smart-cache / WP 6.1 / PHP 7.4"
            php: "7.4"
            wp: "6.1"
            theme: twentytwentyone
            multisite: false
            coverage: false
          # Experimental: WordPress trunk (allowed to fail)
          - name: "wp-graphql-smart-cache / WP trunk / PHP 8.4"
            php: "8.4"
            wp: trunk
            theme: twentytwentyfive
            multisite: false
            coverage: false
            experimental: true
    uses: ./.github/workflows/integration-tests-reusable.yml
    secrets: inherit
    with:
      name: ${{ matrix.name }}
      plugin_path: plugins/wp-graphql-smart-cache
      plugin_name: wp-graphql-smart-cache
      wp: ${{ matrix.wp }}
      php: ${{ matrix.php }}
      theme: ${{ matrix.theme }}
      multisite: ${{ matrix.multisite }}
      coverage: ${{ matrix.coverage }}
      experimental: ${{ matrix.experimental || false }}

  # ===========================================
  # FINAL STATUS CHECK
  # ===========================================
  # This job always runs and provides a consistent status check name
  # for GitHub branch protection rules. It depends on all conditional
  # test jobs and only fails if required jobs failed (not if they were skipped).
  # ===========================================

  status-check:
    name: "Integration Tests"
    runs-on: ubuntu-latest
    needs: [detect-changes, wp-graphql, wp-graphql-smart-cache]
    if: always()  # Run even if previous jobs were skipped
    steps:
      - name: Check integration test results
        run: |
          # Check if any required jobs failed (excluding skipped)
          if [ "${{ needs.wp-graphql.result }}" == "failure" ]; then
            echo "‚ùå wp-graphql integration tests failed"
            exit 1
          fi
          if [ "${{ needs.wp-graphql-smart-cache.result }}" == "failure" ]; then
            echo "‚ùå wp-graphql-smart-cache integration tests failed"
            exit 1
          fi
          # Allow skipped jobs (expected when files don't change)
          if [ "${{ needs.wp-graphql.result }}" == "skipped" ]; then
            echo "‚ÑπÔ∏è wp-graphql tests skipped (no changes detected)"
          fi
          if [ "${{ needs.wp-graphql-smart-cache.result }}" == "skipped" ]; then
            echo "‚ÑπÔ∏è wp-graphql-smart-cache tests skipped (no changes detected)"
          fi
          echo "‚úÖ All required integration tests passed"
