name: Integration Tests

on:
  push:
    branches:
      - main
      - release/*
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - release/*
  workflow_dispatch:

# Cancel previous workflow run groups that have not completed.
concurrency:
  # Group workflow runs by workflow name, along with the head branch ref of the pull request
  # or otherwise the branch or tag ref.
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================
  # CHANGE DETECTION
  # ===========================================
  # Detects which plugins have changes to determine which test suites to run.
  # Each plugin job depends on this and only runs if its files changed.
  # Release-please PRs (branches starting with "release-please--") will run all tests.
  # ===========================================

  detect-changes:
    name: Detect changes
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      wp-graphql: ${{ steps.filter.outputs.wp-graphql_any_changed }}
      wp-graphql-smart-cache: ${{ steps.filter.outputs.wp-graphql-smart-cache_any_changed }}
      wp-graphql-ide: ${{ steps.filter.outputs.wp-graphql-ide_any_changed }}
      wp-graphql-acf: ${{ steps.filter.outputs.wp-graphql-acf_any_changed }}
      is-release-pr: ${{ steps.check-release-pr.outputs.is-release-pr }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check if release-please PR
        id: check-release-pr
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]] && [[ "${{ github.head_ref }}" =~ ^release-please-- ]]; then
            echo "is-release-pr=true" >> $GITHUB_OUTPUT
            echo "üîî Detected Release PR - will run integration tests for all plugins"
          else
            echo "is-release-pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect changed files
        id: filter
        uses: tj-actions/changed-files@v47
        with:
          files_yaml: |
            wp-graphql:
              - .github/workflows/integration-tests-reusable.yml
              - .github/workflows/integration-tests.yml
              - plugins/wp-graphql/**/*.php
              - plugins/wp-graphql/composer.json
              - plugins/wp-graphql/composer.lock
              - plugins/wp-graphql/package.json
              - plugins/wp-graphql/package-lock.json
              - plugins/wp-graphql/tests/**
              - plugins/wp-graphql/codeception.dist.yml
              - .release-please-manifest.json
              - package.json
              - package-lock.json
              - .wp-env.json
              - bin/**
            wp-graphql-smart-cache:
              - .github/workflows/integration-tests-reusable.yml
              - .github/workflows/integration-tests.yml
              - plugins/wp-graphql-smart-cache/**/*.php
              - plugins/wp-graphql-smart-cache/composer.json
              - plugins/wp-graphql-smart-cache/composer.lock
              - plugins/wp-graphql-smart-cache/package.json
              - plugins/wp-graphql-smart-cache/package-lock.json
              - plugins/wp-graphql-smart-cache/tests/**
              - plugins/wp-graphql-smart-cache/codeception.dist.yml
              - plugins/wp-graphql/**/*.php
              - .release-please-manifest.json
              - package.json
              - package-lock.json
              - .wp-env.json
              - bin/**
            wp-graphql-ide:
              - .github/workflows/integration-tests-reusable.yml
              - .github/workflows/integration-tests.yml
              - plugins/wp-graphql-ide/**/*.php
              - plugins/wp-graphql-ide/**/*.js
              - plugins/wp-graphql-ide/**/*.jsx
              - plugins/wp-graphql-ide/composer.json
              - plugins/wp-graphql-ide/composer.lock
              - plugins/wp-graphql-ide/package.json
              - plugins/wp-graphql-ide/package-lock.json
              - plugins/wp-graphql-ide/tests/**
              - plugins/wp-graphql-ide/codeception.dist.yml
              - plugins/wp-graphql/**/*.php
              - package.json
              - package-lock.json
              - .wp-env.json
              - bin/**
            wp-graphql-acf:
              - .github/workflows/integration-tests-reusable.yml
              - .github/workflows/integration-tests.yml
              - plugins/wp-graphql-acf/**/*.php
              - plugins/wp-graphql-acf/composer.json
              - plugins/wp-graphql-acf/composer.lock
              - plugins/wp-graphql-acf/package.json
              - plugins/wp-graphql-acf/package-lock.json
              - plugins/wp-graphql-acf/tests/**
              - plugins/wp-graphql-acf/codeception.dist.yml
              - plugins/wp-graphql/**/*.php
              - .release-please-manifest.json
              - package.json
              - package-lock.json
              - .wp-env.json
              - bin/**

      - name: Log detected changes
        run: |
          echo "wp-graphql changed: ${{ steps.filter.outputs.wp-graphql_any_changed }}"
          echo "wp-graphql-smart-cache changed: ${{ steps.filter.outputs.wp-graphql-smart-cache_any_changed }}"
          echo "wp-graphql-ide changed: ${{ steps.filter.outputs.wp-graphql-ide_any_changed }}"
          echo "wp-graphql-acf changed: ${{ steps.filter.outputs.wp-graphql-acf_any_changed }}"
          echo "is-release-pr: ${{ steps.check-release-pr.outputs.is-release-pr }}"

  # ===========================================
  # TEST MATRIX
  # ===========================================
  # We use a "boundary testing" approach rather than testing every PHP √ó WP combination.
  # The rationale: if tests pass at version boundaries (oldest + newest), they almost
  # certainly pass for versions in between.
  #
  # - 4 coverage jobs: Latest WP/PHP with all theme √ó multisite combos
  # - 3 boundary jobs: Current stable, mid-range, oldest supported
  # - 1 experimental: WordPress trunk (allowed to fail)
  #
  # Update this matrix when new WP/PHP versions are released:
  # - WordPress releases ~3x/year: https://wordpress.org/about/roadmap/
  # - PHP support: https://www.php.net/supported-versions.php
  # - WP PHP requirements: https://make.wordpress.org/core/handbook/references/php-compatibility-and-target-versions/
  #
  # Last updated: 2026-01-21
  # ===========================================

  # Job naming strategy:
  # - Parent job name: "Integration: plugin / WP X.X / PHP X.X"
  # - Child job name: "theme (modifiers)" (from reusable workflow)
  # - Full name in branch protection: "Integration: wp-graphql / WP 6.9 / PHP 8.4 / twentytwentyfive üìä"
  wp-graphql:
    name: 'Integration: ${{ matrix.name }}'
    needs: detect-changes
    # Run if: plugin has changes OR it's a release-please PR OR manual dispatch
    if: |
      (needs.detect-changes.outputs.wp-graphql == 'true' || 
       needs.detect-changes.outputs.is-release-pr == 'true' || 
       github.event_name == 'workflow_dispatch')
    strategy:
      fail-fast: false
      matrix:
        include:
          # Coverage jobs: Latest WP/PHP with all theme √ó multisite combinations
          - name: 'wp-graphql / WP 6.9 / PHP 8.4'
            php: '8.4'
            wp: '6.9'
            theme: twentytwentyfive
            multisite: false
            coverage: true
          - name: 'wp-graphql / WP 6.9 / PHP 8.4'
            php: '8.4'
            wp: '6.9'
            theme: twentytwentyfive
            multisite: true
            coverage: true
          - name: 'wp-graphql / WP 6.9 / PHP 8.4'
            php: '8.4'
            wp: '6.9'
            theme: twentytwentyone
            multisite: false
            coverage: true
          - name: 'wp-graphql / WP 6.9 / PHP 8.4'
            php: '8.4'
            wp: '6.9'
            theme: twentytwentyone
            multisite: true
            coverage: true
          # Boundary: Current stable
          - name: 'wp-graphql / WP 6.8 / PHP 8.3'
            php: '8.3'
            wp: '6.8'
            theme: twentytwentyfive
            multisite: false
            coverage: false
          # Boundary: Mid-range
          - name: 'wp-graphql / WP 6.5 / PHP 8.1'
            php: '8.1'
            wp: '6.5'
            theme: twentytwentyone
            multisite: false
            coverage: false
          # Boundary: Oldest supported
          - name: 'wp-graphql / WP 6.1 / PHP 7.4'
            php: '7.4'
            wp: '6.1'
            theme: twentytwentyone
            multisite: false
            coverage: false
          # Experimental: WordPress trunk (allowed to fail)
          - name: 'wp-graphql / WP trunk / PHP 8.4'
            php: '8.4'
            wp: trunk
            theme: twentytwentyfive
            multisite: false
            coverage: false
            experimental: true
    uses: ./.github/workflows/integration-tests-reusable.yml
    secrets: inherit
    with:
      name: ${{ matrix.name }}
      plugin_path: plugins/wp-graphql
      plugin_name: wp-graphql
      wp: ${{ matrix.wp }}
      php: ${{ matrix.php }}
      theme: ${{ matrix.theme }}
      multisite: ${{ matrix.multisite }}
      coverage: ${{ matrix.coverage }}
      experimental: ${{ matrix.experimental || false }}

  # ===========================================
  # WP GraphQL Smart Cache
  # ===========================================
  # Tests the WP GraphQL Smart Cache plugin.
  # Smart Cache depends on WPGraphQL, so wp-graphql changes trigger these tests.
  # Uses a smaller matrix since coverage is collected from the core plugin.
  # ===========================================

  wp-graphql-smart-cache:
    name: 'Integration: ${{ matrix.name }}'
    needs: detect-changes
    # Run if: plugin has changes OR it's a release-please PR OR manual dispatch
    if: |
      (needs.detect-changes.outputs.wp-graphql-smart-cache == 'true' || 
       needs.detect-changes.outputs.is-release-pr == 'true' || 
       github.event_name == 'workflow_dispatch')
    strategy:
      fail-fast: false
      matrix:
        include:
          # Coverage job: Latest WP/PHP
          - name: 'wp-graphql-smart-cache / WP 6.9 / PHP 8.4'
            php: '8.4'
            wp: '6.9'
            theme: twentytwentyfive
            multisite: false
            coverage: true
          # Boundary: Current stable
          - name: 'wp-graphql-smart-cache / WP 6.8 / PHP 8.3'
            php: '8.3'
            wp: '6.8'
            theme: twentytwentyfive
            multisite: false
            coverage: false
          # Boundary: Oldest supported (matches wp-graphql PHP 7.4 requirement)
          - name: 'wp-graphql-smart-cache / WP 6.1 / PHP 7.4'
            php: '7.4'
            wp: '6.1'
            theme: twentytwentyone
            multisite: false
            coverage: false
          # Experimental: WordPress trunk (allowed to fail)
          - name: 'wp-graphql-smart-cache / WP trunk / PHP 8.4'
            php: '8.4'
            wp: trunk
            theme: twentytwentyfive
            multisite: false
            coverage: false
            experimental: true
    uses: ./.github/workflows/integration-tests-reusable.yml
    secrets: inherit
    with:
      name: ${{ matrix.name }}
      plugin_path: plugins/wp-graphql-smart-cache
      plugin_name: wp-graphql-smart-cache
      wp: ${{ matrix.wp }}
      php: ${{ matrix.php }}
      theme: ${{ matrix.theme }}
      multisite: ${{ matrix.multisite }}
      coverage: ${{ matrix.coverage }}
      experimental: ${{ matrix.experimental || false }}

  # ===========================================
  # WP GraphQL IDE
  # ===========================================
  # Tests the WP GraphQL IDE plugin.
  # IDE depends on WPGraphQL, so wp-graphql changes trigger these tests.
  # Uses a smaller matrix since coverage is collected from the core plugin.
  # ===========================================

  wp-graphql-ide:
    name: 'Integration: ${{ matrix.name }}'
    needs: detect-changes
    if: needs.detect-changes.outputs.wp-graphql-ide == 'true' || github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Coverage job: Latest WP/PHP
          - name: 'wp-graphql-ide / WP 6.9 / PHP 8.4'
            php: '8.4'
            wp: '6.9'
            theme: twentytwentyfive
            multisite: false
            coverage: true
          # Boundary: Current stable
          - name: 'wp-graphql-ide / WP 6.8 / PHP 8.3'
            php: '8.3'
            wp: '6.8'
            theme: twentytwentyfive
            multisite: false
            coverage: false
          # Boundary: Oldest supported (matches wp-graphql PHP 7.4 requirement)
          - name: 'wp-graphql-ide / WP 6.1 / PHP 7.4'
            php: '7.4'
            wp: '6.1'
            theme: twentytwentyone
            multisite: false
            coverage: false
          # Experimental: WordPress trunk (allowed to fail)
          - name: 'wp-graphql-ide / WP trunk / PHP 8.4'
            php: '8.4'
            wp: trunk
            theme: twentytwentyfive
            multisite: false
            coverage: false
            experimental: true
    uses: ./.github/workflows/integration-tests-reusable.yml
    secrets: inherit
    with:
      name: ${{ matrix.name }}
      plugin_path: plugins/wp-graphql-ide
      plugin_name: wp-graphql-ide
      wp: ${{ matrix.wp }}
      php: ${{ matrix.php }}
      theme: ${{ matrix.theme }}
      multisite: ${{ matrix.multisite }}
      coverage: ${{ matrix.coverage }}
      experimental: ${{ matrix.experimental || false }}

  # ===========================================
  # WP GraphQL for ACF
  # ===========================================
  # Tests the WP GraphQL for ACF plugin.
  # ACF plugin depends on WPGraphQL, so wp-graphql changes trigger these tests.
  # Tests against multiple ACF configurations: Free, Pro, and ACF Extended variations.
  # ===========================================

  wp-graphql-acf:
    name: 'Integration: ${{ matrix.name }}'
    needs: detect-changes
    # Run if: plugin has changes OR it's a release-please PR OR manual dispatch.
    # Pro/Extended Pro rows that are missing the required license secret fail early
    # in the reusable workflow with a clear message (see integration-tests-reusable.yml).
    if: |
      needs.detect-changes.outputs.wp-graphql-acf == 'true' ||
      needs.detect-changes.outputs.is-release-pr == 'true' ||
      github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Coverage job: Latest WP/PHP with ACF Pro + ACF Extended Pro
          - name: 'wp-graphql-acf / WP 6.9 / PHP 8.4 / ACF Pro + ACF Extended Pro'
            php: '8.4'
            wp: '6.9'
            theme: twentytwentyfive
            multisite: false
            coverage: true
            acf_pro: true
            acf_extended: true
            acf_extended_pro: true
          # Boundary: Current stable with ACF Free
          - name: 'wp-graphql-acf / WP 6.8 / PHP 8.3 / ACF Free'
            php: '8.3'
            wp: '6.8'
            theme: twentytwentyfive
            multisite: false
            coverage: false
            acf_pro: false
            acf_extended: false
            acf_extended_pro: false
          # Boundary: Current stable with ACF Pro
          - name: 'wp-graphql-acf / WP 6.8 / PHP 8.3 / ACF Pro'
            php: '8.3'
            wp: '6.8'
            theme: twentytwentyfive
            multisite: false
            coverage: false
            acf_pro: true
            acf_extended: false
            acf_extended_pro: false
          # Boundary: Current stable with ACF Free + ACF Extended Free
          - name: 'wp-graphql-acf / WP 6.8 / PHP 8.3 / ACF Free + ACF Extended Free'
            php: '8.3'
            wp: '6.8'
            theme: twentytwentyfive
            multisite: false
            coverage: false
            acf_pro: false
            acf_extended: true
            acf_extended_pro: false
          # Boundary: Oldest WP supported by ACF (6.2+) with PHP 7.4 / ACF Free
          - name: 'wp-graphql-acf / WP 6.2 / PHP 7.4 / ACF Free'
            php: '7.4'
            wp: '6.2'
            theme: twentytwentyone
            multisite: false
            coverage: false
            acf_pro: false
            acf_extended: false
            acf_extended_pro: false
          # Experimental: WordPress trunk (allowed to fail) with ACF Pro
          - name: 'wp-graphql-acf / WP trunk / PHP 8.4 / ACF Pro'
            php: '8.4'
            wp: trunk
            theme: twentytwentyfive
            multisite: false
            coverage: false
            experimental: true
            acf_pro: true
            acf_extended: false
            acf_extended_pro: false
    uses: ./.github/workflows/integration-tests-reusable.yml
    secrets: inherit
    with:
      name: ${{ matrix.name }}
      plugin_path: plugins/wp-graphql-acf
      plugin_name: wp-graphql-acf
      wp: ${{ matrix.wp }}
      php: ${{ matrix.php }}
      theme: ${{ matrix.theme }}
      multisite: ${{ matrix.multisite }}
      coverage: ${{ matrix.coverage }}
      experimental: ${{ matrix.experimental || false }}
      acf_pro: ${{ matrix.acf_pro && 'true' || 'false' }}
      acf_extended: ${{ matrix.acf_extended && 'true' || 'false' }}
      acf_extended_pro: ${{ matrix.acf_extended_pro && 'true' || 'false' }}
      install_wp_graphql_core_deps: true

  # ===========================================
  # FINAL STATUS CHECK
  # ===========================================
  # This job always runs and provides a consistent status check name
  # for GitHub branch protection rules. It depends on all conditional
  # test jobs and only fails if required jobs failed (not if they were skipped).
  # ===========================================

  status-check:
    name: 'Integration Tests'
    runs-on: ubuntu-latest
    needs: [detect-changes, wp-graphql, wp-graphql-smart-cache, wp-graphql-ide, wp-graphql-acf]
    if: always() # Run even if previous jobs were skipped
    steps:
      - name: Check integration test results
        run: |
          # Check if any required jobs failed (excluding skipped)
          if [ "${{ needs.wp-graphql.result }}" == "failure" ]; then
            echo "‚ùå wp-graphql integration tests failed"
            exit 1
          fi
          if [ "${{ needs.wp-graphql-smart-cache.result }}" == "failure" ]; then
            echo "‚ùå wp-graphql-smart-cache integration tests failed"
            exit 1
          fi
          # Allow skipped jobs (expected when files don't change)
          if [ "${{ needs.wp-graphql.result }}" == "skipped" ]; then
            echo "‚ÑπÔ∏è wp-graphql tests skipped (no changes detected)"
          fi
          if [ "${{ needs.wp-graphql-smart-cache.result }}" == "skipped" ]; then
            echo "‚ÑπÔ∏è wp-graphql-smart-cache tests skipped (no changes detected)"
          fi
          if [ "${{ needs.wp-graphql-ide.result }}" == "failure" ]; then
            echo "‚ùå wp-graphql-ide integration tests failed"
            exit 1
          fi
          if [ "${{ needs.wp-graphql-ide.result }}" == "skipped" ]; then
            echo "‚ÑπÔ∏è wp-graphql-ide tests skipped (no changes detected)"
          fi
          if [ "${{ needs.wp-graphql-acf.result }}" == "failure" ]; then
            echo "‚ùå wp-graphql-acf integration tests failed"
            exit 1
          fi
          if [ "${{ needs.wp-graphql-acf.result }}" == "skipped" ]; then
            echo "‚ÑπÔ∏è wp-graphql-acf tests skipped (no changes detected)"
          fi
          echo "‚úÖ All required integration tests passed"
