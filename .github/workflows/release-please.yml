# ===========================================
# RELEASE PLEASE WORKFLOW
# ===========================================
#
# This workflow uses Google's release-please to automate releases:
# 1. On push to main, release-please analyzes commits since last release
# 2. It creates/updates a Release PR with version bump and changelog
# 3. @since x-release-please-version placeholders are replaced with actual version (native to release-please)
# 4. When the Release PR is merged, it creates a GitHub release and tag
# 5. The deploy job then publishes to WordPress.org
#
# VERSION DETERMINATION:
# - feat: commits trigger a MINOR version bump
# - fix: commits trigger a PATCH version bump
# - feat!: or fix!: (with !) trigger a MAJOR version bump
# - chore:, docs:, ci:, etc. are included in changelog but don't trigger releases
#
# SQUASH MERGE WORKFLOW:
# This workflow expects PRs to be squash-merged with conventional commit titles.
# The PR title becomes the commit message, which release-please uses to determine
# the version bump. PR titles are validated by lint-pr.yml.
#
# ===========================================

name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      wp-graphql--release_created: ${{ steps.release.outputs['plugins/wp-graphql--release_created'] }}
      wp-graphql--tag_name: ${{ steps.release.outputs['plugins/wp-graphql--tag_name'] }}
      wp-graphql--version: ${{ steps.release.outputs['plugins/wp-graphql--version'] }}
      wp-graphql--major: ${{ steps.release.outputs['plugins/wp-graphql--major'] }}
      wp-graphql--minor: ${{ steps.release.outputs['plugins/wp-graphql--minor'] }}
      wp-graphql--patch: ${{ steps.release.outputs['plugins/wp-graphql--patch'] }}
    steps:
      - name: Run release-please
        uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.REPO_PAT }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Debug release-please outputs
        if: ${{ inputs.debug || github.event_name == 'workflow_dispatch' }}
        run: |
          echo "=== RELEASE PLEASE OUTPUTS ==="
          echo "releases_created: ${{ steps.release.outputs.releases_created }}"
          echo "wp-graphql--release_created: ${{ steps.release.outputs['plugins/wp-graphql--release_created'] }}"
          echo "wp-graphql--tag_name: ${{ steps.release.outputs['plugins/wp-graphql--tag_name'] }}"
          echo "wp-graphql--version: ${{ steps.release.outputs['plugins/wp-graphql--version'] }}"
          echo "=============================="

  deploy-wp-graphql:
    name: Deploy WPGraphQL to WordPress.org
    needs: release-please
    if: ${{ needs.release-please.outputs['wp-graphql--release_created'] == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: mbstring, intl
          tools: composer

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Subversion
        run: sudo apt-get update && sudo apt-get install -y subversion

      - name: Install PHP dependencies
        working-directory: plugins/wp-graphql
        run: composer install --no-dev --optimize-autoloader

      - name: Install Node dependencies and build
        run: |
          npm ci
          npm run -w @wpgraphql/wp-graphql build

      - name: WordPress Plugin Deploy
        uses: 10up/action-wordpress-plugin-deploy@stable
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SLUG: wp-graphql
          BUILD_DIR: plugins/wp-graphql
          VERSION: ${{ needs.release-please.outputs['wp-graphql--version'] }}

      - name: Create artifact directory
        run: mkdir -p plugin-build

      - name: Create plugin artifact
        working-directory: plugins/wp-graphql
        run: composer run-script zip

      - name: Upload artifact to workflow
        uses: actions/upload-artifact@v4
        with:
          name: wp-graphql
          path: plugin-build/wp-graphql.zip

      - name: Upload artifact to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs['wp-graphql--tag_name'] }}
          files: plugin-build/wp-graphql.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "=== RELEASE SUMMARY ==="
          echo "Version: ${{ needs.release-please.outputs['wp-graphql--version'] }}"
          echo "Tag: ${{ needs.release-please.outputs['wp-graphql--tag_name'] }}"
          echo "Deployed to WordPress.org: âœ…"
          echo "======================="
