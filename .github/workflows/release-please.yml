# ===========================================
# RELEASE PLEASE WORKFLOW
# ===========================================
#
# This workflow uses Google's release-please to automate releases:
# 1. On push to main, release-please analyzes commits since last release
# 2. It creates/updates a Release PR with version bump and changelog
# 3. @since x-release-please-version placeholders are replaced with actual version (native to release-please)
# 4. When the Release PR is merged, it creates a GitHub release and tag
# 5. The deploy job then publishes to WordPress.org
#
# VERSION DETERMINATION:
# - feat: commits trigger a MINOR version bump
# - fix: commits trigger a PATCH version bump
# - feat!: or fix!: (with !) trigger a MAJOR version bump
# - chore:, docs:, ci:, etc. are included in changelog but don't trigger releases
#
# SQUASH MERGE WORKFLOW:
# This workflow expects PRs to be squash-merged with conventional commit titles.
# The PR title becomes the commit message, which release-please uses to determine
# the version bump. PR titles are validated by lint-pr.yml.
#
# ===========================================

name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      debug:
        description: "Enable debug logging"
        required: false
        type: boolean
        default: false
      redeploy_version:
        description: "Re-deploy an existing release (e.g., wp-graphql/v2.7.0 or 2.7.0). Leave empty to run normal release-please workflow."
        required: false
        type: string
        default: ""

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    if: github.event.inputs.redeploy_version == '' || github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      wp-graphql--release_created: ${{ steps.release.outputs['plugins/wp-graphql--release_created'] }}
      wp-graphql--tag_name: ${{ steps.release.outputs['plugins/wp-graphql--tag_name'] }}
      wp-graphql--version: ${{ steps.release.outputs['plugins/wp-graphql--version'] }}
      wp-graphql--major: ${{ steps.release.outputs['plugins/wp-graphql--major'] }}
      wp-graphql--minor: ${{ steps.release.outputs['plugins/wp-graphql--minor'] }}
      wp-graphql--patch: ${{ steps.release.outputs['plugins/wp-graphql--patch'] }}
    steps:
      - name: Run release-please
        uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.REPO_PAT }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Debug release-please outputs
        if: ${{ inputs.debug || github.event_name == 'workflow_dispatch' }}
        run: |
          echo "=== RELEASE PLEASE OUTPUTS ==="
          echo "releases_created: ${{ steps.release.outputs.releases_created }}"
          echo "wp-graphql--release_created: ${{ steps.release.outputs['plugins/wp-graphql--release_created'] }}"
          echo "wp-graphql--tag_name: ${{ steps.release.outputs['plugins/wp-graphql--tag_name'] }}"
          echo "wp-graphql--version: ${{ steps.release.outputs['plugins/wp-graphql--version'] }}"
          echo "=============================="

  deploy-wp-graphql:
    name: Deploy WPGraphQL to WordPress.org
    needs: release-please
    if: |
      always() &&
      (
        (needs.release-please.result == 'success' && needs.release-please.outputs['wp-graphql--release_created'] == 'true') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.redeploy_version != '')
      )
    runs-on: ubuntu-latest
    steps:
      - name: Determine version and tag
        id: version_info
        run: |
          if [[ "${{ github.event.inputs.redeploy_version }}" != "" ]]; then
            INPUT="${{ github.event.inputs.redeploy_version }}"
            
            # Check if input is already a full tag (contains /)
            if [[ "$INPUT" == *"/"* ]]; then
              # Full tag format (e.g., wp-graphql/v2.7.0)
              TAG="$INPUT"
              # Extract version by removing component/v prefix
              VERSION=$(echo "$TAG" | sed 's|.*/v\?||')
            else
              # Just version number (e.g., 2.7.0 or v2.7.0)
              VERSION="$INPUT"
              # Remove 'v' prefix if present
              VERSION="${VERSION#v}"
              # Construct full tag (assumes wp-graphql for now, but could be made configurable)
              TAG="wp-graphql/v${VERSION}"
            fi
            
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "tag_name=${TAG}" >> $GITHUB_OUTPUT
            echo "is_redeploy=true" >> $GITHUB_OUTPUT
            echo "Re-deploying version: ${VERSION} (tag: ${TAG})"
          else
            VERSION="${{ needs.release-please.outputs['wp-graphql--version'] }}"
            TAG="${{ needs.release-please.outputs['wp-graphql--tag_name'] }}"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "tag_name=${TAG}" >> $GITHUB_OUTPUT
            echo "is_redeploy=false" >> $GITHUB_OUTPUT
            echo "Deploying new release: ${VERSION} (tag: ${TAG})"
          fi

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.version_info.outputs.is_redeploy == 'true' && steps.version_info.outputs.tag_name || 'main' }}
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: mbstring, intl
          tools: composer

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Install Subversion
        run: sudo apt-get update && sudo apt-get install -y subversion

      - name: Install PHP dependencies
        working-directory: plugins/wp-graphql
        run: composer install --no-dev --optimize-autoloader

      - name: Install Node dependencies and build
        run: |
          npm ci
          npm run -w @wpgraphql/wp-graphql build

      - name: Create clean build directory for deployment
        working-directory: plugins/wp-graphql
        run: |
          echo "ðŸ“¦ Creating clean build directory using .distignore..."
          echo "This ensures only production files are included (respects .distignore)"
          
          # Create the build directory (same as zip script does)
          mkdir -p ../../plugin-build/wp-graphql
          
          # Use rsync with .distignore to create a clean copy (same as zip script)
          # This respects .distignore and excludes node_modules, packages, etc.
          rsync -rc --exclude-from=.distignore --exclude=plugin-build . ../../plugin-build/wp-graphql/ --delete --delete-excluded -v
          
          echo "âœ… Clean build directory created at plugin-build/wp-graphql"
          echo "ðŸ“‹ Verifying no node_modules in build directory..."
          if find ../../plugin-build/wp-graphql -type d -name "node_modules" 2>/dev/null | grep -q .; then
            echo "âš ï¸  Warning: node_modules found in build directory!"
            find ../../plugin-build/wp-graphql -type d -name "node_modules" 2>/dev/null | head -5
            exit 1
          else
            echo "âœ… No node_modules found in build directory"
          fi
          
          echo "ðŸ“¦ Files in build directory:"
          ls -la ../../plugin-build/wp-graphql | head -20

      - name: WordPress Plugin Deploy
        uses: 10up/action-wordpress-plugin-deploy@stable
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SLUG: wp-graphql
          BUILD_DIR: plugin-build/wp-graphql
          VERSION: ${{ steps.version_info.outputs.version }}

      - name: Create plugin zip artifact
        run: |
          cd plugin-build
          zip -r wp-graphql.zip wp-graphql

      - name: Upload artifact to workflow
        uses: actions/upload-artifact@v6
        with:
          name: wp-graphql
          path: plugin-build/wp-graphql.zip

      - name: Upload artifact to release
        if: steps.version_info.outputs.is_redeploy == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version_info.outputs.tag_name }}
          files: plugin-build/wp-graphql.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "=== RELEASE SUMMARY ==="
          echo "Version: ${{ steps.version_info.outputs.version }}"
          echo "Tag: ${{ steps.version_info.outputs.tag_name }}"
          echo "Is Re-deploy: ${{ steps.version_info.outputs.is_redeploy }}"
          echo "Deployed to WordPress.org: âœ…"
          echo "======================="
