name: Reusable Integration Tests

on:
  workflow_call:
    inputs:
      name:
        description: "Display name for the job (e.g., WP 6.9 / PHP 8.4)"
        required: true
        type: string
      plugin_path:
        description: "Path to the plugin directory (e.g., plugins/wp-graphql)"
        required: true
        type: string
      plugin_name:
        description: "Name of the plugin (e.g., wp-graphql)"
        required: true
        type: string
      wp:
        description: "WordPress version (e.g., 6.9, trunk)"
        required: true
        type: string
      php:
        description: "PHP version (e.g., 8.4)"
        required: true
        type: string
      theme:
        description: "Theme to activate (e.g., twentytwentyfive)"
        required: true
        type: string
      multisite:
        description: "Whether to run as multisite"
        required: true
        type: boolean
      coverage:
        description: "Whether to collect code coverage"
        required: true
        type: boolean
      experimental:
        description: "Whether this is an experimental job (allowed to fail)"
        required: false
        type: boolean
        default: false

jobs:
  # Job naming strategy:
  # The parent workflow sets name to "Integration: plugin / WP X.X / PHP X.X".
  # However, GitHub's sidebar only shows partial names for reusable workflow groups.
  # So we include PHP in the child job name too for visibility when expanded.
  # Full header: "Integration: wp-graphql / WP 6.9 / PHP 8.4 / PHP 8.4 - twentytwentyfive ðŸ“Š"
  # Yes, PHP is duplicated, but this ensures it's visible somewhere in the UI.
  #
  # Runs integration tests for a WordPress plugin using Codeception.
  #
  # Performs the following steps:
  # - Checks out the repository.
  # - Sets up PHP with the specified version.
  # - Installs Composer and NPM dependencies.
  # - Builds JavaScript assets.
  # - Starts the wp-env Docker testing environment.
  # - Activates the test theme.
  # - Runs Acceptance, Functional, and WPUnit tests.
  # - Uploads test failure artifacts and code coverage reports.
  test:
    name: "PHP ${{ inputs.php }} - ${{ inputs.theme }}${{ inputs.multisite && ' (Multisite)' || '' }}${{ inputs.coverage && ' ðŸ“Š' || '' }}${{ inputs.experimental && ' ðŸ§ª' || '' }}"
    runs-on: ubuntu-24.04
    continue-on-error: ${{ inputs.experimental }}
    permissions:
      contents: read
    timeout-minutes: 30
    env:
      WP_ENV_PHP_VERSION: ${{ inputs.php }}
      WP_ENV_CORE: ${{ inputs.wp == 'trunk' && 'WordPress/WordPress' || format('https://wordpress.org/wordpress-{0}.zip', inputs.wp) }}

    steps:
      - name: Configure environment variables
        run: |
          echo "PHP_FPM_UID=$(id -u)" >> "$GITHUB_ENV"
          echo "PHP_FPM_GID=$(id -g)" >> "$GITHUB_ENV"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          show-progress: ${{ runner.debug == '1' && 'true' || 'false' }}
          persist-credentials: false

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php }}
          tools: composer:v2
          extensions: json, mbstring

      - name: Install Composer dependencies
        uses: ramsey/composer-install@v3
        with:
          working-directory: ${{ inputs.plugin_path }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          cache: "npm"
          node-version-file: ".nvmrc"

      - name: Install NPM dependencies
        run: npm ci

      - name: Build JavaScript assets
        run: npm run build

      - name: Cache Docker images
        uses: ScribeMD/docker-cache@0.5.0
        with:
          key: docker-${{ runner.os }}-${{ inputs.php }}-${{ inputs.wp }}

      - name: Start the Docker testing environment
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            npm run wp-env start -- ${{ inputs.coverage && '--xdebug=coverage' || '' }} ${{ secrets.ACTIONS_STEP_DEBUG && '--debug' || '' }}

      - name: Log versions
        run: |
          npm run wp-env -- run cli php -- -v
          npm run wp-env -- run cli wp core version

      - name: Activate test theme
        run: |
          echo "Activating theme: ${{ inputs.theme }}"
          npm run wp-env run tests-cli -- wp theme activate ${{ inputs.theme }}
          npm run wp-env run tests-cli -- wp theme list

      - name: Verify test environment
        run: |
          echo "Checking mu-plugin installation..."
          npm run wp-env run tests-cli -- ls -la /var/www/html/wp-content/mu-plugins/
          echo "Checking site URL..."
          npm run wp-env run tests-cli -- wp option get siteurl
          echo "Active theme..."
          npm run wp-env run tests-cli -- wp theme status
          echo "Testing GraphQL endpoint..."
          npm run wp-env run tests-cli -- curl -s -o /dev/null -w "HTTP %{http_code}" http://tests-wordpress/graphql?query=%7B__typename%7D

      - name: Run Acceptance Tests
        run: |
          npm run -w @wpgraphql/${{ inputs.plugin_name }} test:codecept:acceptance -- ${{ secrets.ACTIONS_STEP_DEBUG && '--debug' || '' }} ${{ inputs.coverage && '--coverage --coverage-xml' || '' }}

      - name: Run Functional Tests
        run: |
          npm run -w @wpgraphql/${{ inputs.plugin_name }} test:codecept:functional -- ${{ secrets.ACTIONS_STEP_DEBUG && '--debug' || '' }}

      - name: Run WPUnit Tests
        env:
          MULTISITE: ${{ inputs.multisite && 'true' || '' }}
          TEST_THEME: ${{ inputs.theme }}
        run: |
          npm run wp-env -- run tests-cli --env-cwd=wp-content/plugins/${{ inputs.plugin_name }}/ -- bash -c 'MULTISITE=${{ inputs.multisite && 'true' || 'false' }} TEST_THEME=${{ inputs.theme }} vendor/bin/codecept run wpunit ${{ secrets.ACTIONS_STEP_DEBUG && '--debug' || '' }} ${{ inputs.coverage && '--coverage --coverage-xml' || '' }}'

      - name: Upload test failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.plugin_name }}-test-failures-php${{ inputs.php }}-wp${{ inputs.wp }}${{ inputs.multisite && '-multisite' || '' }}
          path: ${{ inputs.plugin_path }}/tests/_output/*.fail.html
          if-no-files-found: ignore

      - name: Fix coverage paths
        if: ${{ inputs.coverage }}
        run: |
          # Strip Docker container path prefix from coverage report
          sed -i 's|/var/www/html/wp-content/plugins/${{ inputs.plugin_name }}/||g' ${{ inputs.plugin_path }}/tests/_output/coverage.xml

      - name: Upload coverage to Codecov
        if: ${{ inputs.coverage }}
        uses: codecov/codecov-action@v5
        with:
          files: ${{ inputs.plugin_path }}/tests/_output/coverage.xml
          flags: wpunit,${{ inputs.theme }},${{ inputs.multisite && 'multisite' || 'single' }}
          fail_ci_if_error: false

      - name: Upload HTML coverage report as artifact
        if: ${{ inputs.coverage }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.plugin_name }}-code-coverage-${{ inputs.php }}-${{ inputs.wp }}-${{ inputs.theme }}-${{ inputs.multisite && 'multisite' || 'single' }}
          path: ${{ inputs.plugin_path }}/tests/_output/html
          overwrite: true
