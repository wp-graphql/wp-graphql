name: Reusable Integration Tests

on:
  workflow_call:
    inputs:
      name:
        description: 'Display name for the job (e.g., WP 6.9 / PHP 8.4)'
        required: true
        type: string
      plugin_path:
        description: 'Path to the plugin directory (e.g., plugins/wp-graphql)'
        required: true
        type: string
      plugin_name:
        description: 'Name of the plugin (e.g., wp-graphql)'
        required: true
        type: string
      wp:
        description: 'WordPress version (e.g., 6.9, trunk)'
        required: true
        type: string
      php:
        description: 'PHP version (e.g., 8.4)'
        required: true
        type: string
      theme:
        description: 'Theme to activate (e.g., twentytwentyfive)'
        required: true
        type: string
      multisite:
        description: 'Whether to run as multisite'
        required: true
        type: boolean
      coverage:
        description: 'Whether to collect code coverage'
        required: true
        type: boolean
      experimental:
        description: 'Whether this is an experimental job (allowed to fail)'
        required: false
        type: boolean
        default: false
      acf_pro:
        description: "Whether to install ACF Pro (requires ACF_LICENSE_KEY secret). Pass 'true' or 'false'."
        required: false
        type: string
        default: 'false'
      acf_version:
        description: 'Specific ACF version to install (optional, defaults to latest)'
        required: false
        type: string
        default: ''
      acf_extended:
        description: "Whether to install ACF Extended. Pass 'true' or 'false'."
        required: false
        type: string
        default: 'false'
      acf_extended_pro:
        description: "Whether to install ACF Extended Pro (requires ACF_EXTENDED_LICENSE_KEY secret). Pass 'true' or 'false'."
        required: false
        type: string
        default: 'false'
      wpgraphql_content_blocks:
        description: 'Whether to install WPGraphQL Content Blocks'
        required: false
        type: boolean
        default: false

jobs:
  # Job naming strategy:
  # The parent workflow sets name to "Integration: plugin / WP X.X / PHP X.X".
  # The child job name shows theme + modifiers (no PHP to avoid duplication).
  # Full header: "Integration: wp-graphql / WP 6.9 / PHP 8.4 / twentytwentyfive üìä"
  # Note: GitHub's sidebar may not show all info, but header/branch protection will.
  #
  # Runs integration tests for a WordPress plugin using Codeception.
  #
  # Performs the following steps:
  # - Checks out the repository.
  # - Sets up PHP with the specified version.
  # - Installs Composer and NPM dependencies.
  # - Builds JavaScript assets.
  # - Starts the wp-env Docker testing environment.
  # - Activates the test theme.
  # - Runs Acceptance, Functional, and WPUnit tests.
  # - Uploads test failure artifacts and code coverage reports.
  test:
    name: "${{ inputs.theme }}${{ inputs.multisite && ' (Multisite)' || '' }}${{ inputs.coverage && ' üìä' || '' }}${{ inputs.experimental && ' üß™' || '' }}"
    runs-on: ubuntu-24.04
    continue-on-error: ${{ inputs.experimental }}
    permissions:
      contents: read
    timeout-minutes: 30
    env:
      WP_ENV_PHP_VERSION: ${{ inputs.php }}
      WP_ENV_CORE: ${{ inputs.wp == 'trunk' && 'WordPress/WordPress' || format('https://wordpress.org/wordpress-{0}.zip', inputs.wp) }}

    steps:
      - name: Configure environment variables
        run: |
          echo "PHP_FPM_UID=$(id -u)" >> "$GITHUB_ENV"
          echo "PHP_FPM_GID=$(id -g)" >> "$GITHUB_ENV"

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          show-progress: ${{ runner.debug == '1' && 'true' || 'false' }}
          persist-credentials: false

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php }}
          tools: composer:v2
          extensions: json, mbstring

      - name: Install Composer dependencies
        uses: ramsey/composer-install@v3
        with:
          working-directory: ${{ inputs.plugin_path }}

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          cache: 'npm'
          node-version-file: '.nvmrc'

      - name: Install NPM dependencies
        run: npm ci

      - name: Build JavaScript assets
        run: npm run build -- --filter='./plugins/*'

      - name: Cache Docker images
        uses: ScribeMD/docker-cache@0.5.0
        with:
          key: docker-${{ runner.os }}-${{ inputs.php }}-${{ inputs.wp }}

      - name: Start the Docker testing environment
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            ${{ inputs.coverage && github.actor != 'dependabot[bot]' && 'PCOV_ENABLED=1 ' || '' }}npm run wp-env start -- ${{ secrets.ACTIONS_STEP_DEBUG && '--debug' || '' }}

      - name: Log versions
        run: |
          npm run wp-env -- run cli php -- -v
          npm run wp-env -- run cli wp core version

      - name: Activate test theme
        run: |
          echo "Activating theme: ${{ inputs.theme }}"
          npm run wp-env run tests-cli -- wp theme activate ${{ inputs.theme }}
          npm run wp-env run tests-cli -- wp theme list

      - name: Install ACF plugins (if configured)
        # Always install ACF for wp-graphql-acf plugin (it's required)
        # For other plugins, only install if explicitly requested
        if: inputs.plugin_name == 'wp-graphql-acf' || inputs.acf_pro == 'true' || inputs.acf_extended == 'true' || inputs.wpgraphql_content_blocks == true
        env:
          ACF_LICENSE_KEY: ${{ secrets.ACF_LICENSE_KEY }}
          ACF_EXTENDED_LICENSE_KEY: ${{ secrets.ACF_EXTENDED_LICENSE_KEY }}
          # Pass boolean inputs via env so shell conditions work reliably (workflow_call booleans)
          INPUT_ACF_PRO: ${{ inputs.acf_pro }}
          INPUT_ACF_EXTENDED: ${{ inputs.acf_extended }}
          INPUT_ACF_EXTENDED_PRO: ${{ inputs.acf_extended_pro }}
          INPUT_PLUGIN_NAME: ${{ inputs.plugin_name }}
        run: |
          echo "Installing ACF plugins based on configuration..."
          echo "  INPUT_ACF_PRO=$INPUT_ACF_PRO INPUT_ACF_EXTENDED=$INPUT_ACF_EXTENDED INPUT_ACF_EXTENDED_PRO=$INPUT_ACF_EXTENDED_PRO"
          
          # Determine ACF plugin slug based on Pro/Free
          ACF_PLUGIN_SLUG="advanced-custom-fields/acf.php"
          if [ "$INPUT_ACF_PRO" = "true" ] && [ -n "$ACF_LICENSE_KEY" ] && [ "$ACF_LICENSE_KEY" != "" ]; then
            echo "Installing ACF Pro..."
            ACF_VERSION_PARAM=""
            if [ -n "${{ inputs.acf_version }}" ] && [ "${{ inputs.acf_version }}" != "" ]; then
              ACF_VERSION_PARAM="&t=${{ inputs.acf_version }}"
            fi
            npm run wp-env run tests-cli -- wp plugin install "https://connect.advancedcustomfields.com/v2/plugins/download?p=pro&k=${ACF_LICENSE_KEY}${ACF_VERSION_PARAM}" --activate --quiet --allow-root
            ACF_PLUGIN_SLUG="advanced-custom-fields-pro/acf.php"
          elif [ "$INPUT_ACF_PRO" = "true" ] || [ "$INPUT_ACF_EXTENDED" = "true" ] || [ "${{ inputs.wpgraphql_content_blocks }}" == "true" ] || [ "$INPUT_PLUGIN_NAME" = "wp-graphql-acf" ]; then
            echo "Installing ACF Free..."
            if [ -n "${{ inputs.acf_version }}" ] && [ "${{ inputs.acf_version }}" != "" ]; then
              npm run wp-env run tests-cli -- wp plugin install advanced-custom-fields --version=${{ inputs.acf_version }} --activate --allow-root
            else
              npm run wp-env run tests-cli -- wp plugin install advanced-custom-fields --activate --allow-root
            fi
          fi
          
          # Install ACF Extended
          # Auto-match version: If ACF Pro is installed, try to install ACF Extended Pro (if license key available)
          # Otherwise install ACF Extended Free
          # Use PHP to parse JSON (PHP is available in WordPress containers, more reliable than jq)
          ACF_EXTENDED_PLUGIN_SLUG="acf-extended/acf-extended.php"
          # Install ACF Extended when requested OR for wp-graphql-acf (functional tests expect it)
          if [ "$INPUT_ACF_EXTENDED" = "true" ] || [ "$INPUT_PLUGIN_NAME" = "wp-graphql-acf" ]; then
            # If ACF Pro is installed, automatically try ACF Extended Pro (if license key available)
            # This matches the behavior of the local install-acf.sh script
            if [ "$INPUT_ACF_PRO" = "true" ] && [ -n "$ACF_EXTENDED_LICENSE_KEY" ] && [ "$ACF_EXTENDED_LICENSE_KEY" != "" ]; then
              echo "Installing ACF Extended Pro (matching ACF Pro)..."
              # Use PHP to parse JSON instead of jq (PHP is available in WordPress containers)
              INSTALL_RESULT=$(npm run wp-env run tests-cli -- bash -c "
                download_link=\$(curl -s --location --request GET 'https://acf-extended.com?edd_action=get_version&license=${ACF_EXTENDED_LICENSE_KEY}&item_name=ACF%20Extended%20Pro&url=https://acf.wpgraphql.com' | php -r 'echo json_decode(file_get_contents(\"php://stdin\"), true)[\"download_link\"] ?? \"\";');
                download_link=\${download_link%\\\"};
                download_link=\${download_link#\\\"};
                if [ -z \"\$download_link\" ] || [ \"\$download_link\" == \"null\" ] || [ \"\$download_link\" == \"false\" ]; then
                  echo 'ERROR: Invalid license key or download link';
                  exit 1;
                fi;
                wp plugin install \"\$download_link\" --activate --quiet --allow-root;
                echo 'SUCCESS'
              " 2>&1)
              
              if echo "$INSTALL_RESULT" | grep -q "SUCCESS"; then
                ACF_EXTENDED_PLUGIN_SLUG="acf-extended-pro/acf-extended.php"
              elif echo "$INSTALL_RESULT" | grep -q "ERROR: Invalid license key"; then
                echo "‚ö†Ô∏è  Warning: ACF Extended Pro license key appears invalid or expired"
                echo "   Falling back to ACF Extended Free..."
                npm run wp-env run tests-cli -- wp plugin install acf-extended --activate --allow-root
              else
                echo "‚ö†Ô∏è  Warning: Failed to install ACF Extended Pro"
                echo "   Error: $INSTALL_RESULT"
                echo "   Falling back to ACF Extended Free..."
                npm run wp-env run tests-cli -- wp plugin install acf-extended --activate --allow-root
              fi
            # Explicit request for ACF Extended Pro (even with ACF Free) - respect the flag
            elif [ "$INPUT_ACF_EXTENDED_PRO" = "true" ] && [ -n "$ACF_EXTENDED_LICENSE_KEY" ] && [ "$ACF_EXTENDED_LICENSE_KEY" != "" ]; then
              echo "Installing ACF Extended Pro (explicit request)..."
              # Use PHP to parse JSON instead of jq (PHP is available in WordPress containers)
              INSTALL_RESULT=$(npm run wp-env run tests-cli -- bash -c "
                download_link=\$(curl -s --location --request GET 'https://acf-extended.com?edd_action=get_version&license=${ACF_EXTENDED_LICENSE_KEY}&item_name=ACF%20Extended%20Pro&url=https://acf.wpgraphql.com' | php -r 'echo json_decode(file_get_contents(\"php://stdin\"), true)[\"download_link\"] ?? \"\";');
                download_link=\${download_link%\\\"};
                download_link=\${download_link#\\\"};
                if [ -z \"\$download_link\" ] || [ \"\$download_link\" == \"null\" ] || [ \"\$download_link\" == \"false\" ]; then
                  echo 'ERROR: Invalid license key or download link';
                  exit 1;
                fi;
                wp plugin install \"\$download_link\" --activate --quiet --allow-root;
                echo 'SUCCESS'
              " 2>&1)
              
              if echo "$INSTALL_RESULT" | grep -q "SUCCESS"; then
                ACF_EXTENDED_PLUGIN_SLUG="acf-extended-pro/acf-extended.php"
              elif echo "$INSTALL_RESULT" | grep -q "ERROR: Invalid license key"; then
                echo "‚ö†Ô∏è  Warning: ACF Extended Pro license key appears invalid or expired"
                echo "   Falling back to ACF Extended Free..."
                npm run wp-env run tests-cli -- wp plugin install acf-extended --activate --allow-root
              else
                echo "‚ö†Ô∏è  Warning: Failed to install ACF Extended Pro"
                echo "   Error: $INSTALL_RESULT"
                echo "   Falling back to ACF Extended Free..."
                npm run wp-env run tests-cli -- wp plugin install acf-extended --activate --allow-root
              fi
            else
              echo "Installing ACF Extended Free..."
              npm run wp-env run tests-cli -- wp plugin install acf-extended --activate --allow-root
            fi
          fi
          
          # Install WPGraphQL Content Blocks if requested
          if [ "${{ inputs.wpgraphql_content_blocks }}" = "true" ]; then
            echo "Installing WPGraphQL Content Blocks..."
            CONTENT_BLOCKS_VERSION=$(npm run wp-env run tests-cli -- bash -c "curl -s --location --request GET 'https://api.github.com/repos/wpengine/wp-graphql-content-blocks/releases/latest' | jq -r '.tag_name'")
            npm run wp-env run tests-cli -- wp plugin install "https://github.com/wpengine/wp-graphql-content-blocks/releases/download/${CONTENT_BLOCKS_VERSION}/wp-graphql-content-blocks.zip" --activate --allow-root
          fi
          
          # Set environment variables for test scripts
          echo "ACF_PLUGIN_SLUG=${ACF_PLUGIN_SLUG}" >> $GITHUB_ENV
          echo "ACF_EXTENDED_PLUGIN_SLUG=${ACF_EXTENDED_PLUGIN_SLUG}" >> $GITHUB_ENV
          
          # List installed plugins for verification
          echo "Installed plugins:"
          npm run wp-env run tests-cli -- wp plugin list --allow-root

      - name: Verify test environment
        run: |
          echo "Checking mu-plugin installation..."
          npm run wp-env run tests-cli -- ls -la /var/www/html/wp-content/mu-plugins/
          echo "Checking site URL..."
          npm run wp-env run tests-cli -- wp option get siteurl
          echo "Active theme..."
          npm run wp-env run tests-cli -- wp theme status
          echo "Testing GraphQL endpoint..."
          npm run wp-env run tests-cli -- curl -s -o /dev/null -w "HTTP %{http_code}" http://tests-wordpress/graphql?query=%7B__typename%7D

      - name: Run Acceptance Tests
        run: |
          npm run -w @wpgraphql/${{ inputs.plugin_name }} test:codecept:acceptance -- ${{ secrets.ACTIONS_STEP_DEBUG && '--debug' || '' }} ${{ inputs.coverage && github.actor != 'dependabot[bot]' && '--coverage --coverage-xml' || '' }}

      - name: Run Functional Tests
        run: |
          npm run -w @wpgraphql/${{ inputs.plugin_name }} test:codecept:functional -- ${{ secrets.ACTIONS_STEP_DEBUG && '--debug' || '' }}

      - name: Run WPUnit Tests
        env:
          MULTISITE: ${{ inputs.multisite && 'true' || '' }}
          TEST_THEME: ${{ inputs.theme }}
          ACF_PLUGIN_SLUG: ${{ env.ACF_PLUGIN_SLUG }}
          ACF_EXTENDED_PLUGIN_SLUG: ${{ env.ACF_EXTENDED_PLUGIN_SLUG }}
        run: |
          npm run wp-env -- run tests-cli --env-cwd=wp-content/plugins/${{ inputs.plugin_name }}/ -- bash -c 'export TEST_DB_HOST=${WORDPRESS_DB_HOST:-tests-mysql} TEST_DB_NAME=${WORDPRESS_DB_NAME:-tests-wordpress} TEST_DB_USER=${WORDPRESS_DB_USER:-root} TEST_DB_PASSWORD=${WORDPRESS_DB_PASSWORD:-password} TEST_WP_TABLE_PREFIX=${TEST_WP_TABLE_PREFIX:-wp_} TEST_WP_DOMAIN=${TEST_WP_DOMAIN:-localhost} TEST_ADMIN_EMAIL=${TEST_ADMIN_EMAIL:-admin@example.org} TEST_WP_ROOT_FOLDER=${TEST_WP_ROOT_FOLDER:-/var/www/html} MULTISITE=${{ inputs.multisite && 'true' || 'false' }} TEST_THEME=${{ inputs.theme }} ACF_PLUGIN_SLUG=${ACF_PLUGIN_SLUG:-} ACF_EXTENDED_PLUGIN_SLUG=${ACF_EXTENDED_PLUGIN_SLUG:-} && vendor/bin/codecept run wpunit ${{ secrets.ACTIONS_STEP_DEBUG && '--debug' || '' }} ${{ inputs.coverage && github.actor != 'dependabot[bot]' && '--coverage --coverage-xml' || '' }}'

      - name: Upload test failure artifacts
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.plugin_name }}-test-failures-php${{ inputs.php }}-wp${{ inputs.wp }}${{ inputs.multisite && '-multisite' || '' }}
          path: ${{ inputs.plugin_path }}/tests/_output/*.fail.html
          if-no-files-found: ignore

      - name: Fix coverage paths
        # Skip coverage steps for Dependabot PRs - dependency updates don't change coverage
        if: ${{ inputs.coverage && github.actor != 'dependabot[bot]' }}
        run: |
          # Map Docker container paths to repo-relative paths for Codecov
          sed -i "s|/var/www/html/wp-content/plugins/${{ inputs.plugin_name }}/|${{ inputs.plugin_path }}/|g" ${{ inputs.plugin_path }}/tests/_output/coverage.xml

      - name: Verify coverage file exists
        # Skip coverage steps for Dependabot PRs - dependency updates don't change coverage
        if: ${{ inputs.coverage && github.actor != 'dependabot[bot]' }}
        run: |
          if [ ! -f "${{ inputs.plugin_path }}/tests/_output/coverage.xml" ]; then
            echo "‚ùå Coverage file not found!"
            exit 1
          fi
          echo "‚úÖ Coverage file exists: ${{ inputs.plugin_path }}/tests/_output/coverage.xml"
          echo "File size: $(wc -c < "${{ inputs.plugin_path }}/tests/_output/coverage.xml") bytes"

      - name: Upload coverage to Codecov
        # Skip coverage steps for Dependabot PRs - dependency updates don't change coverage
        if: ${{ inputs.coverage && github.actor != 'dependabot[bot]' }}
        uses: codecov/codecov-action@v5
        with:
          files: ${{ inputs.plugin_path }}/tests/_output/coverage.xml
          flags: ${{ inputs.plugin_name }}-wpunit-${{ inputs.theme }}-${{ inputs.multisite && 'multisite' || 'single' }}
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN || '' }}
          slug: wp-graphql/wp-graphql
          verbose: true

      - name: Upload HTML coverage report as artifact
        # Skip coverage steps for Dependabot PRs - dependency updates don't change coverage
        if: ${{ inputs.coverage && github.actor != 'dependabot[bot]' }}
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.plugin_name }}-code-coverage-${{ inputs.php }}-${{ inputs.wp }}-${{ inputs.theme }}-${{ inputs.multisite && 'multisite' || 'single' }}
          path: ${{ inputs.plugin_path }}/tests/_output/html
          overwrite: true
