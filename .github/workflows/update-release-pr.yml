# ===========================================
# UPDATE RELEASE PR WORKFLOW
# ===========================================
#
# This workflow runs when release-please creates or updates a Release PR.
# It handles tasks that release-please doesn't do natively:
#
# 1. Replaces x-release-please-version placeholders with actual version
# 2. Updates the Upgrade Notice section in readme.txt if there are breaking changes
# 3. Regenerates the POT file for translations (if languages/ directory exists)
#
# The workflow identifies release-please PRs by:
# - Branch name starting with "release-please--"
# - Label "autorelease: pending"
#
# ===========================================

name: Update Release PR

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  update-release-pr:
    name: Update Release PR
    # Only run on release-please PRs
    if: startsWith(github.head_ref, 'release-please--')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install WP-CLI
        run: |
          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          sudo mv wp-cli.phar /usr/local/bin/wp
          wp --info

      - name: Extract version and component from PR
        id: version_info
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          BRANCH_NAME: ${{ github.head_ref }}
        run: |
          # Extract version and component from the PR title or branch name
          # Release-please PR titles are like "chore(main): release wp-graphql 2.7.0"
          # Branch names are like "release-please--branches--main--components--wp-graphql"

          # Extract component from PR title (e.g., "wp-graphql" from "release wp-graphql 2.7.0")
          COMPONENT=$(echo "$PR_TITLE" | grep -oE 'release\s+([a-z0-9-]+)' | awk '{print $2}' || echo "")

          if [ -z "$COMPONENT" ]; then
            # Fallback: extract from branch name
            COMPONENT=$(echo "$BRANCH_NAME" | sed 's/.*--components--//' || echo "wp-graphql")
          fi

          # Try to get version from PR title first
          VERSION=$(echo "$PR_TITLE" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)

          if [ -z "$VERSION" ]; then
            # Fallback: extract from CHANGELOG.md (first version header)
            PLUGIN_DIR="plugins/${COMPONENT}"
            if [ -f "${PLUGIN_DIR}/CHANGELOG.md" ]; then
              VERSION=$(grep -oE '## \[?[0-9]+\.[0-9]+\.[0-9]+' "${PLUGIN_DIR}/CHANGELOG.md" | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "component=$COMPONENT" >> $GITHUB_OUTPUT
          echo "plugin_dir=plugins/${COMPONENT}" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION for component: $COMPONENT"

      - name: Replace x-release-please-version placeholders
        if: steps.version_info.outputs.version != ''
        working-directory: ${{ steps.version_info.outputs.plugin_dir }}
        env:
          VERSION: ${{ steps.version_info.outputs.version }}
        run: |
          echo "ðŸ”„ Replacing x-release-please-version placeholders with ${VERSION}..."

          # Replace in all PHP files
          find . -type f -name "*.php" -exec sed -i.bak "s/x-release-please-version/${VERSION}/g" {} \;
          find . -type f -name "*.php.bak" -delete

          # Replace in readme.txt (Stable tag field)
          # Handle both placeholder format and existing version numbers
          if [[ -f "readme.txt" ]]; then
            # First try to replace placeholder
            sed -i.bak "s/Stable tag: x-release-please-version/Stable tag: ${VERSION}/" readme.txt
            # Also replace any existing version number (for updates to existing Release PRs)
            sed -i.bak "s/^Stable tag: [0-9]\+\.[0-9]\+\.[0-9]\+/Stable tag: ${VERSION}/" readme.txt
            rm -f readme.txt.bak
            
            # Verify the update
            if grep -q "Stable tag: ${VERSION}" readme.txt; then
              echo "âœ… Stable tag updated to ${VERSION}"
            else
              echo "::warning::Failed to verify Stable tag update"
              echo "Current Stable tag line:"
              grep "^Stable tag:" readme.txt || echo "  (not found)"
            fi
          fi

          echo "âœ… Placeholders replaced"

          # Count remaining placeholders (excluding docs which are examples)
          REMAINING=$(grep -r "x-release-please-version" . 2>/dev/null | grep -v "docs/" | grep -v ".git" | wc -l || echo "0")
          if [ "$REMAINING" -gt 0 ]; then
            echo "âš ï¸  Warning: $REMAINING placeholder(s) still remain (excluding docs):"
            grep -r "x-release-please-version" . 2>/dev/null | grep -v "docs/" | grep -v ".git" | head -5
          else
            echo "âœ… All placeholders replaced (docs examples excluded)"
          fi

      - name: Update version constants
        if: steps.version_info.outputs.version != ''
        env:
          VERSION: ${{ steps.version_info.outputs.version }}
          COMPONENT: ${{ steps.version_info.outputs.component }}
          PLUGIN_DIR: ${{ steps.version_info.outputs.plugin_dir }}
        run: |
          node scripts/update-version-constants.js \
            --version="$VERSION" \
            --component="$COMPONENT" \
            --plugin-dir="$PLUGIN_DIR"

      - name: Update Upgrade Notice
        if: steps.version_info.outputs.version != ''
        env:
          VERSION: ${{ steps.version_info.outputs.version }}
          PLUGIN_DIR: ${{ steps.version_info.outputs.plugin_dir }}
        run: |
          node scripts/update-upgrade-notice.js \
            --version="$VERSION" \
            --plugin-dir="$PLUGIN_DIR"

      - name: Check for languages directory
        id: i18n
        env:
          PLUGIN_DIR: ${{ steps.version_info.outputs.plugin_dir }}
        run: |
          if [ -d "${PLUGIN_DIR}/languages" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
            echo "Languages directory found - will regenerate POT file"
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "No languages directory - skipping POT generation"
          fi

      - name: Regenerate POT file
        if: steps.i18n.outputs.enabled == 'true' && steps.version_info.outputs.version != ''
        working-directory: ${{ steps.version_info.outputs.plugin_dir }}
        env:
          COMPONENT: ${{ steps.version_info.outputs.component }}
        run: |
          wp i18n make-pot . languages/${COMPONENT}.pot \
            --slug=${COMPONENT} \
            --domain=${COMPONENT} \
            --include=src,access-functions.php,*.php \
            --exclude=node_modules,vendor,tests,build,packages
          echo "POT file regenerated: languages/${COMPONENT}.pot"

      - name: Check for changes
        id: changes
        env:
          PLUGIN_DIR: ${{ steps.version_info.outputs.plugin_dir }}
        run: |
          CHANGED_FILES=""

          # Check if any files changed
          if ! git diff --quiet "$PLUGIN_DIR"; then
            CHANGED_FILES=$(git diff --name-only "$PLUGIN_DIR")
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in:"
            echo "$CHANGED_FILES"
            echo ""
            echo "Diff:"
            git diff "$PLUGIN_DIR"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.changed == 'true'
        env:
          PLUGIN_DIR: ${{ steps.version_info.outputs.plugin_dir }}
          COMPONENT: ${{ steps.version_info.outputs.component }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add "$PLUGIN_DIR"
          git commit -m "chore: replace x-release-please-version placeholders, update upgrade notice, and regenerate translations for ${COMPONENT}"
          git push
