# ===========================================
# TESTING INTEGRATION WORKFLOW
# ===========================================
#
# MATRIX STRATEGY:
# ----------------
# We use a "boundary testing" approach rather than testing every PHP Ã— WP combination.
# The rationale: if tests pass at version boundaries (oldest + newest), they almost
# certainly pass for versions in between. This reduces CI time from ~40 jobs to ~8-18
# while maintaining confidence in compatibility.
#
# TWO MATRIX MODES:
# - MINIMAL (regular PRs): ~8 jobs for quick feedback
# - FULL (merges to main + release PRs): ~18 jobs for thorough pre-release testing
#
# COVERAGE STRATEGY:
# Code coverage is collected from 4 configurations on the latest WP/PHP:
# - Block theme (twentytwentyfive) Ã— single site
# - Block theme (twentytwentyfive) Ã— multisite
# - Classic theme (twentytwentyone) Ã— single site
# - Classic theme (twentytwentyone) Ã— multisite
# This ensures we capture code paths specific to themes and multisite.
#
# EXPERIMENTAL JOBS:
# WordPress trunk (nightly) is tested but allowed to fail. This gives us early
# warning of upcoming breaking changes without blocking PRs.
#
# VERSION MAINTENANCE:
# Update this matrix when new WP/PHP versions are released:
# - WordPress releases ~3x/year: https://wordpress.org/about/roadmap/
# - PHP support: https://www.php.net/supported-versions.php
# - WP PHP requirements: https://make.wordpress.org/core/handbook/references/php-compatibility-and-target-versions/
#
# Last updated: 2026-01-09
# ===========================================

name: Testing Integration

on:
  push:
    branches:
      - main
      - release/*
  pull_request:
    branches:
      - main
      - release/*
    paths:
      - '.github/workflows/testing-integration.yml'
      - 'plugins/wp-graphql/**/*.php'
      - 'plugins/wp-graphql/composer.json'
      - 'plugins/wp-graphql/composer.lock'
      - 'plugins/wp-graphql/package.json'
      - 'plugins/wp-graphql/package-lock.json'
      - 'package.json'
      - 'package-lock.json'
      - '.wp-env.json'
      - 'bin/**'
      - 'plugins/wp-graphql/bin/**'
      - 'plugins/wp-graphql/tests/**'
      - 'plugins/wp-graphql/codeception.dist.yml'
      - '!plugins/wp-graphql/docs/**'

# Cancel previous workflow run groups that have not completed.
concurrency:
  # Group workflow runs by workflow name, along with the head branch ref of the pull request
  # or otherwise the branch or tag ref.
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  # Determine which matrix to use based on event type
  setup-matrix:
    name: Setup Test Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Set matrix
        id: set-matrix
        run: |
          # Use full matrix for:
          # - Push events (merges to main)
          # - Release PRs (PRs from release-please with title starting with "chore: release")
          # Use minimal matrix for:
          # - Regular PRs targeting main
          
          # Check if this is a release-please PR (full matrix needed for release validation)
          # release-please generates titles like: "chore(main): release wp-graphql 2.7.0"
          IS_RELEASE_PR="false"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            # Match "chore: release" or "chore(scope): release" patterns
            # Store regex in variable to avoid bash parsing issues with special characters
            RELEASE_PATTERN='^chore(\([^)]+\))?:[[:space:]]release'
            if [[ "$PR_TITLE" =~ $RELEASE_PATTERN ]]; then
              IS_RELEASE_PR="true"
            fi
          fi
          
          if [[ "${{ github.event_name }}" == "pull_request" && "$IS_RELEASE_PR" == "false" ]]; then
            # ===========================================
            # MINIMAL MATRIX (~8 jobs)
            # For regular PRs - provides quick feedback
            # ===========================================
            # - 4 coverage jobs: Latest WP/PHP with all theme Ã— multisite combos
            # - 3 boundary jobs: Current stable, mid-range, oldest supported
            # - 1 experimental: WordPress trunk (allowed to fail)
            echo 'matrix={
              "include": [
                { "wp": "6.9", "php": "8.4", "theme": "twentytwentyfive", "multisite": false, "coverage": true, "experimental": false },
                { "wp": "6.9", "php": "8.4", "theme": "twentytwentyfive", "multisite": true, "coverage": true, "experimental": false },
                { "wp": "6.9", "php": "8.4", "theme": "twentytwentyone", "multisite": false, "coverage": true, "experimental": false },
                { "wp": "6.9", "php": "8.4", "theme": "twentytwentyone", "multisite": true, "coverage": true, "experimental": false },
                { "wp": "6.8", "php": "8.3", "theme": "twentytwentyfive", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.5", "php": "8.1", "theme": "twentytwentyone", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.1", "php": "7.4", "theme": "twentytwentyone", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "trunk", "php": "8.4", "theme": "twentytwentyfive", "multisite": false, "coverage": false, "experimental": true }
              ]
            }' | tr -d '\n' >> $GITHUB_OUTPUT
          else
            # ===========================================
            # FULL MATRIX (~18 jobs)
            # For merges to main and release-please PRs
            # Provides thorough testing before releases
            # ===========================================
            # - 4 coverage jobs: Latest WP/PHP with all theme Ã— multisite combos
            # - 6 PHP version jobs: All supported PHP versions on latest stable WP
            # - 7 WP version jobs: All supported WP versions (one PHP each)
            # - 1 experimental: WordPress trunk (allowed to fail)
            echo 'matrix={
              "include": [
                { "wp": "6.9", "php": "8.4", "theme": "twentytwentyfive", "multisite": false, "coverage": true, "experimental": false },
                { "wp": "6.9", "php": "8.4", "theme": "twentytwentyfive", "multisite": true, "coverage": true, "experimental": false },
                { "wp": "6.9", "php": "8.4", "theme": "twentytwentyone", "multisite": false, "coverage": true, "experimental": false },
                { "wp": "6.9", "php": "8.4", "theme": "twentytwentyone", "multisite": true, "coverage": true, "experimental": false },
                { "wp": "6.8", "php": "8.4", "theme": "twentytwentyfive", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.8", "php": "8.3", "theme": "twentytwentyfive", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.8", "php": "8.2", "theme": "twentytwentyone", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.8", "php": "8.1", "theme": "twentytwentyone", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.8", "php": "8.0", "theme": "twentytwentyone", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.8", "php": "7.4", "theme": "twentytwentyone", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.7", "php": "8.3", "theme": "twentytwentyfive", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.6", "php": "8.3", "theme": "twentytwentyone", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.5", "php": "8.2", "theme": "twentytwentyone", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.4", "php": "8.1", "theme": "twentytwentyone", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.3", "php": "8.0", "theme": "twentytwentyone", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.2", "php": "7.4", "theme": "twentytwentyone", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "6.1", "php": "7.4", "theme": "twentytwentyone", "multisite": false, "coverage": false, "experimental": false },
                { "wp": "trunk", "php": "8.4", "theme": "twentytwentyfive", "multisite": false, "coverage": false, "experimental": true }
              ]
            }' | tr -d '\n' >> $GITHUB_OUTPUT
          fi

  codeception:
    name: WP ${{ matrix.wp }} / PHP ${{ matrix.php }} / ${{ matrix.theme }} ${{ matrix.multisite && '/ Multisite' || '' }} ${{ matrix.coverage && '(Coverage)' || '' }} ${{ matrix.experimental && 'ðŸ§ª' || '' }}
    needs: setup-matrix
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental || false }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    env:
      WP_ENV_PHP_VERSION: ${{ matrix.php }}
      WP_ENV_CORE: ${{ matrix.wp == 'trunk' && 'WordPress/WordPress' || format( 'https://wordpress.org/wordpress-{0}.zip', matrix.wp ) }}

    steps:
      - name: Configure environment variables
        run: |
            echo "PHP_FPM_UID=$(id -u)" >> "$GITHUB_ENV"
            echo "PHP_FPM_GID=$(id -g)" >> "$GITHUB_ENV"

      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
            show-progress: ${{ runner.debug == '1' && 'true' || 'false' }}
            persist-credentials: false

      - name: Set up PHP
        uses: shivammathur/setup-php@ec406be512d7077f68eed36e63f4d91bc006edc4 # v2.35.4
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
          extensions: json, mbstring

      - name: Install Composer dependencies
        uses: ramsey/composer-install@3cf229dc2919194e9e36783941438d17239e8520 # v3.1.1
        with:
          working-directory: plugins/wp-graphql

      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
            cache: 'npm'
            node-version-file: '.nvmrc'

      - name: Install NPM dependencies
        run: npm ci

      - name: Build JavaScript assets
        run: npm run build

      - name: Cache Docker images
        uses: ScribeMD/docker-cache@0.5.0
        with:
          key: docker-${{ runner.os }}-${{ matrix.php }}-${{ matrix.wp }}

      - name: Start the Docker testing environment
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3.0.2
        with:
            timeout_minutes: 10
            max_attempts: 3
            command: |
                npm run wp-env start -- ${{ matrix.coverage && '--xdebug=coverage' || '' }} ${{ secrets.ACTIONS_STEP_DEBUG && '--debug' || '' }}

      - name: Log versions
        run: |
            npm run wp-env -- run cli php -- -v
            npm run wp-env -- run cli wp core version

      - name: Activate test theme
        run: |
            echo "Activating theme: ${{ matrix.theme }}"
            npm run wp-env run tests-cli -- wp theme activate ${{ matrix.theme }}
            npm run wp-env run tests-cli -- wp theme list

      - name: Verify test environment
        run: |
            echo "Checking mu-plugin installation..."
            npm run wp-env run tests-cli -- ls -la /var/www/html/wp-content/mu-plugins/
            echo "Checking site URL..."
            npm run wp-env run tests-cli -- wp option get siteurl
            echo "Active theme..."
            npm run wp-env run tests-cli -- wp theme status
            echo "Testing GraphQL endpoint..."
            npm run wp-env run tests-cli -- curl -s -o /dev/null -w "HTTP %{http_code}" http://tests-wordpress/graphql?query=%7B__typename%7D

      - name: Run Acceptance Tests
        run: |
          npm run -w @wpgraphql/wp-graphql test:codecept:acceptance -- ${{ secrets.ACTIONS_STEP_DEBUG && '--debug' || '' }} ${{ matrix.coverage && '--coverage --coverage-xml' || '' }}

      - name: Run Functional Tests
        run: |
          npm run -w @wpgraphql/wp-graphql test:codecept:functional -- ${{ secrets.ACTIONS_STEP_DEBUG && '--debug' || '' }}

      - name: Run WPUnit Tests
        env:
          MULTISITE: ${{ matrix.multisite && 'true' || '' }}
          TEST_THEME: ${{ matrix.theme }}
        run: |
          npm run wp-env -- run tests-cli --env-cwd=wp-content/plugins/wp-graphql/ -- bash -c 'MULTISITE=${{ matrix.multisite && 'true' || 'false' }} TEST_THEME=${{ matrix.theme }} vendor/bin/codecept run wpunit ${{ secrets.ACTIONS_STEP_DEBUG && '--debug' || '' }} ${{ matrix.coverage && '--coverage --coverage-xml' || '' }}'

      - name: Upload test failure artifacts
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
            name: test-failures-php${{ matrix.php }}-wp${{ matrix.wp }}${{ matrix.multisite && '-multisite' || '' }}
            path: plugins/wp-graphql/tests/_output/*.fail.html
            if-no-files-found: ignore

      - name: Fix coverage paths
        if: ${{ matrix.coverage }}
        run: |
            # Strip Docker container path prefix from coverage report
            sed -i 's|/var/www/html/wp-content/plugins/wp-graphql/||g' plugins/wp-graphql/tests/_output/coverage.xml

      - name: Upload coverage to Codecov
        if: ${{ matrix.coverage }}
        uses: codecov/codecov-action@18283e04ce6e62d37312384ff67231eb8fd56d24 # v5.4.3
        with:
            files: plugins/wp-graphql/tests/_output/coverage.xml
            flags: wpunit,${{ matrix.theme }},${{ matrix.multisite && 'multisite' || 'single' }}
            fail_ci_if_error: false

      - name: Upload HTML coverage report as artifact
        if: ${{ matrix.coverage }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
            name: wp-code-coverage-${{ matrix.php }}-${{ matrix.wp }}-${{ matrix.theme }}-${{ matrix.multisite && 'multisite' || 'single' }}
            path: plugins/wp-graphql/tests/_output/html
            overwrite: true
