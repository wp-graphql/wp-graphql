# ===========================================
# SMOKE TEST WORKFLOW
# ===========================================
#
# PURPOSE:
# Validates the production zip artifact works correctly by:
# 1. Building the plugin zip (same as release process)
# 2. Installing it in a clean WordPress environment
# 3. Running smoke tests to verify core functionality
#
# This catches issues that unit tests might miss:
# - Missing files from .distignore
# - Build/bundling problems
# - Activation errors
# - Missing dependencies in production
#
# LOCAL USAGE:
# For basic smoke testing against your running wp-env:
#   npm run wp-env start
#   ./bin/smoke-test.sh
#
# To test the production zip artifact (mimicking CI):
#   See docs/TESTING.md#testing-the-production-zip-artifact
#
# ===========================================

name: Smoke Test

on:
  push:
    branches:
      - main
      - release/*
  pull_request:
    branches:
      - main
      - release/*
    paths:
      - '.github/workflows/smoke-test.yml'
      - 'plugins/wp-graphql/**/*.php'
      - 'plugins/wp-graphql/composer.json'
      - 'plugins/wp-graphql/.distignore'
      - 'plugins/wp-graphql/package.json'
      - 'plugins/wp-graphql/packages/**'
      - 'plugins/wp-graphql/webpack.config.js'
      - 'package.json'
      - '.wp-env.json'
      - 'bin/smoke-test.sh'

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  smoke-test:
    name: Smoke Test (WP ${{ matrix.wp }} / PHP ${{ matrix.php }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Test on latest stable
          - wp: '6.8'
            php: '8.3'
          # Test on oldest supported
          - wp: '6.1'
            php: '7.4'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
          extensions: json, mbstring

      - name: Install Composer dependencies (production)
        uses: ramsey/composer-install@v3
        with:
          working-directory: plugins/wp-graphql
          # Use --no-dev to match the production release build
          composer-options: '--no-dev --optimize-autoloader'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          cache: 'npm'
          node-version-file: '.nvmrc'

      - name: Install NPM dependencies
        run: npm ci

      - name: Build JavaScript assets
        run: npm run build

      - name: Build plugin zip
        working-directory: plugins/wp-graphql
        run: composer run-script zip

      - name: Verify zip contents
        run: |
          echo "ðŸ“¦ Verifying zip was created..."
          ls -la plugin-build/
          echo ""
          echo "ðŸ“‹ Zip contents:"
          unzip -l plugin-build/wp-graphql.zip | head -50

      # Create a minimal wp-env config with NO plugins
      # We'll install the zip manually via WP-CLI for reliable testing
      - name: Create wp-env config for zip testing
        run: |
          cat > .wp-env.override.json << 'EOF'
          {
            "plugins": [],
            "lifecycleScripts": {
              "afterStart": null
            },
            "mappings": {},
            "env": {
              "development": {
                "plugins": [],
                "mappings": {}
              },
              "tests": {
                "plugins": [],
                "mappings": {}
              }
            }
          }
          EOF
          echo "ðŸ“‹ Created .wp-env.override.json:"
          cat .wp-env.override.json
          echo ""
          echo "ðŸ” Validating JSON syntax..."
          python3 -c "import json; json.load(open('.wp-env.override.json')); print('âœ… JSON is valid')"

      - name: Clean wp-env cache
        run: |
          # Ensure no stale wp-env state interferes with the smoke test
          npm run wp-env destroy -- --force || true
          # Clear the wp-env cache directory to ensure zip is freshly extracted
          rm -rf ~/.wp-env || true

      - name: Start WordPress environment
        env:
          WP_ENV_PHP_VERSION: ${{ matrix.php }}
          WP_ENV_CORE: ${{ format('https://wordpress.org/wordpress-{0}.zip', matrix.wp) }}
        run: npm run wp-env start

      - name: Install plugin from zip via WP-CLI
        run: |
          echo "ðŸ“¦ Copying zip to container..."
          CONTAINER_NAME=$(docker ps --format '{{.Names}}' | grep 'cli-1' | grep -v 'tests' | head -1)
          docker cp plugin-build/wp-graphql.zip "$CONTAINER_NAME":/tmp/wp-graphql.zip

          echo "ðŸ“¦ Installing plugin from zip..."
          npm run wp-env -- run cli wp plugin install /tmp/wp-graphql.zip --activate

          echo "ðŸ”„ Flushing permalinks..."
          npm run wp-env -- run cli wp rewrite structure '/%postname%/' --hard
          npm run wp-env -- run cli wp rewrite flush --hard

          echo "âš™ï¸ Enabling public introspection..."
          npm run wp-env -- run cli wp option update graphql_general_settings '{"graphql_endpoint":"graphql","public_introspection_enabled":"on"}' --format=json

      - name: Verify plugin is active
        run: |
          echo "ðŸ“¦ Installed plugins:"
          npm run wp-env -- run cli wp plugin list
          echo ""
          npm run wp-env -- run cli wp plugin is-active wp-graphql

      - name: Run smoke tests
        run: |
          # Run smoke tests against the WordPress container
          ./bin/smoke-test.sh --verbose

      - name: Check for PHP errors
        if: always()
        run: |
          echo "ðŸ“‹ Checking for PHP errors..."
          npm run wp-env -- run cli cat /var/www/html/wp-content/debug.log 2>/dev/null || echo "No debug.log found"

      - name: Upload tested zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: wp-graphql-smoke-tested-${{ matrix.wp }}-${{ matrix.php }}
          path: plugin-build/wp-graphql.zip

      - name: Stop WordPress environment
        if: always()
        run: npm run wp-env stop
