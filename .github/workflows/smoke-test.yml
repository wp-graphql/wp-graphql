# ===========================================
# SMOKE TEST WORKFLOW
# ===========================================
#
# PURPOSE:
# Validates the production zip artifact works correctly by:
# 1. Building the plugin zip (same as release process)
# 2. Installing it in a clean WordPress environment
# 3. Running smoke tests to verify core functionality
#
# This catches issues that unit tests might miss:
# - Missing files from .distignore
# - Build/bundling problems
# - Activation errors
# - Missing dependencies in production
#
# LOCAL USAGE:
# For basic smoke testing against your running wp-env:
#   npm run wp-env start
#   ./bin/smoke-test.sh
#
# To test the production zip artifact (mimicking CI):
#   See docs/TESTING.md#testing-the-production-zip-artifact
#
# ===========================================

name: Smoke Test

on:
  push:
    branches:
      - main
      - release/*
  pull_request:
    branches:
      - main
      - release/*

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================
  # CHANGE DETECTION
  # ===========================================
  # Detects which plugins have changes to determine which smoke tests to run.
  # Each plugin job depends on this and only runs if its files changed.
  # ===========================================

  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      wp-graphql: ${{ steps.filter.outputs.wp-graphql_any_changed }}
      wp-graphql-smart-cache: ${{ steps.filter.outputs.wp-graphql-smart-cache_any_changed }}
      wp-graphql-ide: ${{ steps.filter.outputs.wp-graphql-ide_any_changed }}
      wp-graphql-acf: ${{ steps.filter.outputs.wp-graphql-acf_any_changed }}
      test_all: ${{ steps.check-context.outputs.test_all }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check context (Release PR or push to main)
        id: check-context
        run: |
          TEST_ALL=false
          # Check if Release PR
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BRANCH_NAME="${{ github.head_ref }}"
            if [[ "$BRANCH_NAME" =~ ^release-please-- ]]; then
              TEST_ALL=true
              echo "üîî Detected Release PR - will smoke test all plugins"
            fi
          # Check if push to main
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            TEST_ALL=true
            echo "Push to main - will smoke test all plugins"
          fi
          echo "test_all=$TEST_ALL" >> $GITHUB_OUTPUT

      - name: Detect changed files
        id: filter
        uses: tj-actions/changed-files@v47
        with:
          files_yaml: |
            wp-graphql:
              - .github/workflows/smoke-test.yml
              - plugins/wp-graphql/**/*.php
              - plugins/wp-graphql/composer.json
              - plugins/wp-graphql/.distignore
              - plugins/wp-graphql/package.json
              - plugins/wp-graphql/packages/**
              - plugins/wp-graphql/webpack.config.js
              - .release-please-manifest.json
              - package.json
              - .wp-env.json
              - bin/smoke-test.sh
            wp-graphql-smart-cache:
              - .github/workflows/smoke-test.yml
              - plugins/wp-graphql-smart-cache/**/*.php
              - plugins/wp-graphql-smart-cache/composer.json
              - plugins/wp-graphql-smart-cache/.distignore
              - plugins/wp-graphql-smart-cache/package.json
              - .release-please-manifest.json
              - package.json
              - .wp-env.json
              - bin/smoke-test.sh
              # Smart cache depends on wp-graphql, so wp-graphql changes trigger smart-cache smoke tests
              - plugins/wp-graphql/**/*.php
            wp-graphql-ide:
              - .github/workflows/smoke-test.yml
              - plugins/wp-graphql-ide/**/*.php
              - plugins/wp-graphql-ide/**/*.js
              - plugins/wp-graphql-ide/**/*.jsx
              - plugins/wp-graphql-ide/composer.json
              - plugins/wp-graphql-ide/.distignore
              - plugins/wp-graphql-ide/package.json
              - plugins/wp-graphql-ide/webpack.config.js
              - package.json
              - .wp-env.json
              - bin/smoke-test.sh
              # IDE depends on wp-graphql, so wp-graphql changes trigger IDE smoke tests
              - plugins/wp-graphql/**/*.php
            wp-graphql-acf:
              - .github/workflows/smoke-test.yml
              - plugins/wp-graphql-acf/**/*.php
              - plugins/wp-graphql-acf/composer.json
              - plugins/wp-graphql-acf/.distignore
              - plugins/wp-graphql-acf/package.json
              - .release-please-manifest.json
              - package.json
              - .wp-env.json
              - bin/smoke-test.sh
              # ACF plugin depends on wp-graphql, so wp-graphql changes trigger ACF smoke tests
              - plugins/wp-graphql/**/*.php

      - name: Log detected changes
        run: |
          echo "wp-graphql changed: ${{ steps.filter.outputs.wp-graphql_any_changed }}"
          echo "wp-graphql-smart-cache changed: ${{ steps.filter.outputs.wp-graphql-smart-cache_any_changed }}"
          echo "wp-graphql-ide changed: ${{ steps.filter.outputs.wp-graphql-ide_any_changed }}"
          echo "wp-graphql-acf changed: ${{ steps.filter.outputs.wp-graphql-acf_any_changed }}"

  # ===========================================
  # SMOKE TEST JOBS
  # ===========================================
  # Each plugin gets smoke tested across different WP/PHP versions.
  # Only runs if the plugin has changes (or if test_all is true).
  # ===========================================

  wp-graphql:
    name: 'Smoke Test: ${{ matrix.name }}'
    needs: detect-changes
    if: needs.detect-changes.outputs.wp-graphql == 'true' || needs.detect-changes.outputs.test_all == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: 'wp-graphql / WP 6.8 / PHP 8.3'
            wp: '6.8'
            php: '8.3'
          - name: 'wp-graphql / WP 6.1 / PHP 7.4'
            wp: '6.1'
            php: '7.4'
    uses: ./.github/workflows/smoke-test-reusable.yml
    with:
      name: ${{ matrix.name }}
      plugin_path: plugins/wp-graphql
      plugin_name: wp-graphql
      composer_working_dir: plugins/wp-graphql
      zip_name: wp-graphql.zip
      plugin_slug: wp-graphql
      requires_wp_graphql: false
      smoke_test_script: bin/smoke-test.sh
      needs_build: true
      wp: ${{ matrix.wp }}
      php: ${{ matrix.php }}

  wp-graphql-smart-cache:
    name: 'Smoke Test: ${{ matrix.name }}'
    needs: detect-changes
    if: needs.detect-changes.outputs.wp-graphql-smart-cache == 'true' || needs.detect-changes.outputs.test_all == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: 'wp-graphql-smart-cache / WP 6.8 / PHP 8.3'
            wp: '6.8'
            php: '8.3'
          - name: 'wp-graphql-smart-cache / WP 6.1 / PHP 7.4'
            wp: '6.1'
            php: '7.4'
    uses: ./.github/workflows/smoke-test-reusable.yml
    with:
      name: ${{ matrix.name }}
      plugin_path: plugins/wp-graphql-smart-cache
      plugin_name: wp-graphql-smart-cache
      composer_working_dir: plugins/wp-graphql-smart-cache
      zip_name: wpgraphql-smart-cache.zip
      # Note: WordPress.org slug is wpgraphql-smart-cache (no hyphen between wp and graphql)
      # This is because WordPress.org doesn't allow "wp-" prefix for new plugins.
      # The directory name (wp-graphql-smart-cache) and GitHub component name can differ.
      plugin_slug: wpgraphql-smart-cache
      requires_wp_graphql: true
      smoke_test_script: bin/smoke-test.sh
      needs_build: false
      wp: ${{ matrix.wp }}
      php: ${{ matrix.php }}

  wp-graphql-ide:
    name: 'Smoke Test: ${{ matrix.name }}'
    needs: detect-changes
    if: needs.detect-changes.outputs.wp-graphql-ide == 'true' || needs.detect-changes.outputs.test_all == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: 'wp-graphql-ide / WP 6.8 / PHP 8.3'
            wp: '6.8'
            php: '8.3'
          - name: 'wp-graphql-ide / WP 6.1 / PHP 7.4'
            wp: '6.1'
            php: '7.4'
    uses: ./.github/workflows/smoke-test-reusable.yml
    with:
      name: ${{ matrix.name }}
      plugin_path: plugins/wp-graphql-ide
      plugin_name: wp-graphql-ide
      composer_working_dir: plugins/wp-graphql-ide
      zip_name: wpgraphql-ide.zip
      # Note: WordPress.org slug is wpgraphql-ide (no hyphen between wp and graphql)
      # This is because WordPress.org doesn't allow "wp-" prefix for new plugins.
      # The directory name (wp-graphql-ide) and GitHub component name can differ.
      # The zip contains a directory named wpgraphql-ide, so that's the plugin slug.
      plugin_slug: wpgraphql-ide
      requires_wp_graphql: true
      smoke_test_script: bin/smoke-test.sh
      needs_build: true
      wp: ${{ matrix.wp }}
      php: ${{ matrix.php }}

  wp-graphql-acf:
    name: 'Smoke Test: ${{ matrix.name }}'
    needs: detect-changes
    if: needs.detect-changes.outputs.wp-graphql-acf == 'true' || needs.detect-changes.outputs.test_all == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: 'wp-graphql-acf / WP 6.8 / PHP 8.3'
            wp: '6.8'
            php: '8.3'
          - name: 'wp-graphql-acf / WP 6.1 / PHP 7.4'
            wp: '6.1'
            php: '7.4'
    uses: ./.github/workflows/smoke-test-reusable.yml
    with:
      name: ${{ matrix.name }}
      plugin_path: plugins/wp-graphql-acf
      plugin_name: wp-graphql-acf
      composer_working_dir: plugins/wp-graphql-acf
      zip_name: wpgraphql-acf.zip
      # Note: WordPress.org slug is wpgraphql-acf (no hyphen between wp and graphql)
      # This is because WordPress.org doesn't allow "wp-" prefix for new plugins.
      # The directory name (wp-graphql-acf) and GitHub component name can differ.
      # The zip contains a directory named wpgraphql-acf, so that's the plugin slug.
      plugin_slug: wpgraphql-acf
      requires_wp_graphql: true
      smoke_test_script: bin/smoke-test.sh
      needs_build: false
      wp: ${{ matrix.wp }}
      php: ${{ matrix.php }}

  # ===========================================
  # FINAL STATUS CHECK
  # ===========================================
  # This job always runs and provides a consistent status check name
  # for GitHub branch protection rules. It depends on all conditional
  # smoke test jobs and only fails if required jobs failed (not if they were skipped).
  # Note: Matrix jobs create multiple status checks, so we check the parent job result.
  # ===========================================

  status-check:
    name: 'Smoke Test'
    runs-on: ubuntu-latest
    needs: [detect-changes, wp-graphql, wp-graphql-smart-cache, wp-graphql-ide, wp-graphql-acf]
    if: always() # Run even if previous jobs were skipped
    steps:
      - name: Check smoke test results
        run: |
          # Check if any required jobs failed (excluding skipped)
          # Matrix jobs: if any matrix job fails, the parent job result is "failure"
          if [ "${{ needs.wp-graphql.result }}" == "failure" ]; then
            echo "‚ùå wp-graphql smoke tests failed"
            exit 1
          fi
          if [ "${{ needs.wp-graphql-smart-cache.result }}" == "failure" ]; then
            echo "‚ùå wp-graphql-smart-cache smoke tests failed"
            exit 1
          fi
          # Allow skipped jobs (expected when files don't change)
          if [ "${{ needs.wp-graphql.result }}" == "skipped" ]; then
            echo "‚ÑπÔ∏è wp-graphql smoke tests skipped (no changes detected)"
          fi
          if [ "${{ needs.wp-graphql-smart-cache.result }}" == "skipped" ]; then
            echo "‚ÑπÔ∏è wp-graphql-smart-cache smoke tests skipped (no changes detected)"
          fi
          if [ "${{ needs.wp-graphql-ide.result }}" == "failure" ]; then
            echo "‚ùå wp-graphql-ide smoke tests failed"
            exit 1
          fi
          if [ "${{ needs.wp-graphql-ide.result }}" == "skipped" ]; then
            echo "‚ÑπÔ∏è wp-graphql-ide smoke tests skipped (no changes detected)"
          fi
          if [ "${{ needs.wp-graphql-acf.result }}" == "failure" ]; then
            echo "‚ùå wp-graphql-acf smoke tests failed"
            exit 1
          fi
          if [ "${{ needs.wp-graphql-acf.result }}" == "skipped" ]; then
            echo "‚ÑπÔ∏è wp-graphql-acf smoke tests skipped (no changes detected)"
          fi
          echo "‚úÖ All required smoke tests passed"
