---
title: "test: only apply URL rewriting for Codeception tests, not Playwright e2e"
pr: 3460
author: "jasonbahl"
type: "test"
breaking: false
---

## What bug does this fix? Explain your changes.

After PR #3451 (ci: replace custom docker with wp-env), the JS e2e tests (Playwright) started failing with the error:

\`\`\`
Error: apiRequestContext.post: getaddrinfo EAI_AGAIN tests-wordpress
\`\`\`

**Root cause:** The mu-plugin installed by \`bin/setup-wp-env.sh\` was unconditionally rewriting all URLs from \`localhost:8889\` to \`http://tests-wordpress\`. This works for **Codeception tests** (which run inside Docker containers where \`tests-wordpress\` hostname resolves), but breaks **Playwright e2e tests** (which run outside Docker and cannot resolve the \`tests-wordpress\` hostname).

**Fix:** Modified the mu-plugin to only apply URL rewriting when the request comes from Codeception tests. Codeception's WPBrowser module sends specific headers (\`X_TEST_REQUEST\` and \`X_WPBROWSER_REQUEST\`) that we check for before applying the URL transformation.

## Does this close any currently open issues?

closes #3457

## Testing Strategy

This fix was verified locally by:
1. Running e2e tests **without** the fix → tests fail with \`getaddrinfo EAI_AGAIN tests-wordpress\`
2. Running e2e tests **with** the fix → all 12 tests pass (1 skipped)

### Test Results

- [x] **Failing test added**: The bug was reproduced in CI (see failing run below)
- [x] **Fix implemented**: Conditional URL rewriting based on request headers
- [x] **All tests passing**: All existing tests continue to pass
- [x] **Regression tests**: Existing e2e and Codeception tests serve as regression tests

### Test Links

- Failing tests: https://github.com/wp-graphql/wp-graphql/actions/runs/20798296161/job/59737357197?pr=3452
- Passing tests: Local verification (12 passed, 1 skipped)

## Before/After Examples

### Before (Buggy Behavior):
\`\`\`php
function wpgraphql_wpenv_fix_url( $url ) {
    // Unconditionally rewrites ALL URLs - breaks Playwright!
    return preg_replace( "#https?://(localhost|tests-wordpress):8889#", "http://tests-wordpress", $url );
}
\`\`\`

### After (Fixed Behavior):
\`\`\`php
function wpgraphql_wpenv_fix_url( $url ) {
    // Only apply URL fix for Codeception tests (WPBrowser).
    // These tests run inside Docker and send specific headers.
    // Playwright e2e tests run outside Docker and need localhost URLs.
    $is_codeception_request = (
        ! empty( $_SERVER["HTTP_X_TEST_REQUEST"] ) ||
        ! empty( $_SERVER["HTTP_X_WPBROWSER_REQUEST"] )
    );

    if ( ! $is_codeception_request ) {
        return $url;
    }

    return preg_replace( "#https?://(localhost|tests-wordpress):8889#", "http://tests-wordpress", $url );
}
\`\`\`

## Additional Context

The URL rewriting mu-plugin is necessary for Codeception acceptance/functional tests because:
- They run WPBrowser from inside the \`tests-cli\` Docker container
- Inside Docker, \`localhost:8889\` doesn't work (only port 80 works internally)
- The \`tests-wordpress\` hostname is resolvable within Docker's internal network

Playwright e2e tests run from outside Docker (on the host machine/CI runner) and need \`localhost:8889\` URLs to work properly.
