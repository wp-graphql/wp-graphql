---
title: "feat: refactor experiment registry for better testability"
pr: 3453
author: "jasonbahl"
type: "feat"
breaking: false
---

## What feature does this implement? Explain your changes.

This PR refactors the \`ExperimentRegistry\` class from a static-only API to an instance-based API, significantly improving testability for the Experiments feature.

**Why this change is needed:**
- The previous static-only design made it difficult to test experiments in isolation
- Tests couldn't easily add/remove experiments without affecting other tests
- Static state persisted between tests, causing flaky test behavior

**Key changes:**
- Converted static properties (\`$registry\`, \`$experiments\`, \`$active_experiments\`) to instance properties
- Added \`get_instance()\` and \`set_instance()\` static methods for singleton access pattern
- Updated all call sites to use the instance-based API
- Fixed \`deprecationReason\` in \`EmailAddressScalarFieldsExperiment\` to use strings instead of callables (fixes introspection visibility)
- Fixed test infrastructure issues (themes permissions, deprecated fields introspection)
- Updated documentation to reflect the new API patterns
- Fixed release workflow \`git add\` patterns to properly stage files in subdirectories

## Does this close any currently open issues?

Relates to ongoing work on the Experiments API testability improvements.

## Feature Design

### API Changes

**Before (static methods):**
\`\`\`php
$experiments = ExperimentRegistry::get_active_experiments();
$isActive = ExperimentRegistry::is_experiment_active('my-experiment');
\`\`\`

**After (instance methods via singleton):**
\`\`\`php
$registry = ExperimentRegistry::get_instance();
$experiments = $registry ? $registry->get_active_experiments() : [];
$isActive = $registry ? $registry->is_experiment_active('my-experiment') : false;
\`\`\`

### Test Isolation Pattern
\`\`\`php
// Each test creates its own fresh registry instance
$this->registry = new ExperimentRegistry();
$this->registry->init();

// Cleanup clears the singleton
ExperimentRegistry::set_instance(null);
\`\`\`

## Implementation Details

### Key Components Added/Modified
- [x] \`ExperimentRegistry.php\` - Converted to instance-based API with singleton access
- [x] \`Admin.php\`, \`Extensions.php\`, \`Experimental.php\` - Updated to use \`get_instance()\`
- [x] \`EmailAddressScalarFieldsExperiment.php\` - Fixed deprecationReason for introspection
- [x] \`TestOptionalDependencyExperiment.php\` - Updated API calls
- [x] Release workflow - Fixed git add patterns for subdirectories

### New Methods on ExperimentRegistry
- \`get_instance(): ?ExperimentRegistry\` - Get the primary singleton instance
- \`set_instance(?ExperimentRegistry $instance): void\` - Set/clear the primary instance
- \`register_experiment(string $slug, string $class_name): void\` - Programmatically register experiments
- \`unregister_experiment(string $slug): void\` - Programmatically unregister experiments
- \`get_registered_experiment(string $slug): ?string\` - Get a single registered experiment class

## Testing Strategy

### Test Coverage
- [x] Unit tests for ExperimentRegistry instance methods
- [x] Integration tests for experiment loading/unloading
- [x] Test isolation verification (each test gets fresh state)
- [x] Fixed \`UserEmailAddressFieldsTest\` - Added \`includeDeprecated: true\` to introspection queries
- [x] Fixed \`RootQueryConnectionsTest\` - Added admin user for themes query (requires \`edit_themes\` capability)

### Test Examples
\`\`\`php
// Creating isolated test instances
public function setUp(): void {
    parent::setUp();
    $this->clearSchema();
    
    // Clear experiment settings
    update_option('graphql_experiments_settings', []);
    
    // Create fresh registry for this test
    $this->registry = new ExperimentRegistry();
}

public function tearDown(): void {
    // Clear the singleton to prevent test pollution
    ExperimentRegistry::set_instance(null);
    parent::tearDown();
}
\`\`\`

## Documentation Updates

### Documentation Changes
- [x] \`docs/experiments-using.md\` - Updated code examples for instance-based API
- [x] \`docs/experiments-creating.md\` - Updated test patterns and debugging examples
- [x] Code documentation (PHPDoc blocks) - All new methods documented

### Breaking Changes

This is an **internal breaking change** for the Experiments API.

| What Changed | Migration Path |
|--------------|----------------|
| \`ExperimentRegistry::get_active_experiments()\` | Use \`ExperimentRegistry::get_instance()->get_active_experiments()\` |
| \`ExperimentRegistry::get_experiments()\` | Use \`ExperimentRegistry::get_instance()->get_experiments()\` |
| \`ExperimentRegistry::is_experiment_active()\` | Use \`ExperimentRegistry::get_instance()->is_experiment_active()\` |
| \`ExperimentRegistry::reset()\` | Use \`ExperimentRegistry::set_instance(null)\` or create fresh instances |

**Note:** The Experiments API is still, well, experimental, so this breaking change does not affect public API stability guarantees.

## Additional Context

### Why Instance-Based Over Static?

1. **Test Isolation**: Each test can create its own registry instance without affecting others
2. **Dependency Injection**: Easier to mock/stub for unit testing
3. **State Management**: Clear ownership of state (instance vs global)
4. **Future Flexibility**: Enables potential multi-tenant or scoped experiment configurations

### Files Changed

| File | Change Type |
|------|-------------|
| \`src/Experimental/ExperimentRegistry.php\` | Major refactor |
| \`src/Experimental/Admin.php\` | API migration |
| \`src/Experimental/Extensions.php\` | API migration |
| \`src/Experimental/Experimental.php\` | API migration |
| \`src/Experimental/Experiment/EmailAddressScalarFieldsExperiment/\` | Bug fix |
| \`src/Experimental/Experiment/TestOptionalDependencyExperiment/\` | API migration |
| \`tests/wpunit/*ExperimentTest.php\` | Test updates |
| \`tests/wpunit/RootQueryConnectionsTest.php\` | Bug fix |
| \`docs/experiments-*.md\` | Documentation |
| \`.github/workflows/release.yml\` | Bug fix |

### Related Work
- Experiments API was introduced to allow testing new features before committing to stable API
- This refactor makes the Experiments API itself more testable and maintainable
