---
title: "ci!: replace custom docker with wp-env"
pr: 3451
author: "jasonbahl"
type: "ci"
breaking: true
---

> [!NOTE]
> This PR is based off https://github.com/wp-graphql/wp-graphql/pull/3446, but I don't have permission to push to the origin so I opened another PR to ensure tests run, etc

> [!IMPORTANT]
> This PR changes the projects \`.env\` files and local development instructions.

This PR replaces our custom docker (and everything required to install + maintain it) with \`@wordpress/env\`. This

1. Reduces project maintenance costs
2. Makes the dockerized container more useful for development, quicker to setup, overload etc
3. In general, makes it easier to contribute, since you no longer need a custom dev environment _or_ a modicum of docker skills
4. Brings things more in line with other canonical plugins.

It also paves the way for:
- An easier path for the 3.2 -> 3.7 codeception migration
- Testing WP/PHP combinations that no longer have docker images autopublished.
- _downstream_ adoption by the plugin ecosystem, since it's a lot easier to copy + maintain.

As a result / in support of the above:

### NPM commands:
- \`lint:php:fix\`, \`lint:php:stan\` and \`lint:php:\` now run through the docker container. (You can still run them locally via \`composer check-cs\` etc)
- new \`npm run test:codecept\` and \`npm run test:codecept:coverage\` let you run \`vendor/bin/codecept\` in the \`tests-cli\` container.
- \`wp-env:cli\` lets you directly access the development container, e.g. \`wp-env:cli bash\` would give you a terminal in the env, or \`wp-env:cli composer install --no-dev --optimize-autoloader\` is how you could build for production without having Composer (or even php) installed locally.

### Tests/env

- ðŸš¨ðŸš¨ðŸš¨ The variables inside \`.env(.dist)\` are now sorted and also used consistently: prefixed \`TEST_\` are used by codeception, nonprefixed are used by \`install-test-env.sh\`. (Later versions of codeception support variable inheritance in \`.env\`)
- wpunit/functional tests have been updated to use whatever local domain is used for testing.
- Acceptance tests now run (again?) during CI
- removed to unnecessary tests.

### Misc
- Activating wp-graphql does a \`flush_rewrite_rules()\` (IMO this was an unreported bug)
- \`debug.log\` messages when using the \`wp-env\` get mapped to \`test/_output/\`
- There are now enough themes to paginate, so the test has been updated

## To test

### WP-Env

1. Stop any other dockers 
   \`\`\`shell
   docker stop $(docker ps -q)
   \`\`\`

2. Install NPM deps and start wp-env
   \`\`\`shell
   nvm use && npm install
   npm run wp-env start
   \`\`\`

3. Try commands:
   \`\`\`
   npm run lint:php
   npm run lint:php:stan
   npm run test:codecept -- run functional
   npm run test:codecept -- run tests/wpunit/AccessFunctionsTest.php -vvv
   npm run env:cli -- wp cache flush
   \`\`\`

### Local dev

1. Backup your old \`.env\` file
2. Copy \`.env.dist\` to \`.env\` and update the values accordingly.
3. Run \`composer install-test-env\` and confirm it works as before.
4. Run \`vendor/bin/codecept run wpunit\` and see passing tests as before (+ ones caused by a hardcoded \`localhost\` if you were using a different env).

## Does this close any currently open issues?



Nope.

## Any other comments?



1. Does not include updating deps, linting, formating, etc beyond on files that we touched by this class (e.g. I didnt undo the indenting required by latest wpbrowser or switch the tabs back in package.json). In general this repo is due for a good \`npm run format\` and some other cleanup tasks, but that's all beyond the scope.
2. A bug in older versions of WP-Browser (which I believe is fixed in 3.7) causes \`$tester->loginAs()\` to fail when run inside a docker container. I could have worked around with with an \`mu-plugin\` to filter the \`siteurl\` when tests are run. But since 
    a) the two failing tests were redundant (functional tests only run because the plugin is activated) and
    b) we have e2e tests via wpenv+playwright and those are a better home for these sorts of admin tests
    so I just opted to remove them.
